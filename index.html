<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Local AI Chatbot</title>

<!-- WebLLM -->
<script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.20/dist/index.min.js"></script>
<!-- SQL.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f7f7f7;color:#111;transition:.3s}
.dark{background:#111;color:#eee}
#app{max-width:900px;margin:0 auto;padding:60px 12px;}
.chat{display:flex;flex-direction:column;gap:20px}
.msg{padding:14px 18px;border-radius:16px;max-width:80%;line-height:1.45;font-size:16px;white-space:pre-wrap}
.user{align-self:flex-end;background:#007aff;color:#fff}
.bot{align-self:flex-start;background:#e8e8e8}
.dark .bot{background:#222}
input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid #ccc;font-size:16px}
#sendBtn{position:absolute;right:18px;bottom:12px;background:#007aff;color:#fff;border:none;padding:8px 14px;border-radius:10px}
#inputBox{position:fixed;bottom:0;left:0;right:0;padding:10px;background:#fff;display:flex;gap:10px}
.dark #inputBox{background:#000}
pre{background:#1e1e1e;color:#eee;padding:12px;border-radius:12px;overflow:auto;font-size:14px}
#themeToggle{position:fixed;top:12px;right:12px;padding:10px;border:none;background:#007aff;color:#fff;border-radius:50%}
</style>
</head>

<body>
<button id="themeToggle">ðŸŒ“</button>
<div id="app">
<div class="chat" id="chat"></div>
</div>

<div id="inputBox">
<input id="userInput" placeholder="Message..." />
<button id="sendBtn">Send</button>
</div>

<script>
/* ------------------------------------------------------------
   INITIALIZATION
------------------------------------------------------------ */
let db, SQL;

(async()=>{
  SQL = await initSqlJs({locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`});
  db = new SQL.Database();
  db.run("CREATE TABLE IF NOT EXISTS docs(id INTEGER PRIMARY KEY, content TEXT, embedding TEXT)");

  await loadModel();
})();

/* ------------------------------------------------------------
   LOAD BGE-SMALL MODEL (WebLLM)
------------------------------------------------------------ */
let llm;
async function loadModel(){
  llm = await webllm.createWebLLM({
    model:"BGE-small",
    onProgress:(p)=>console.log("Loading:",p)
  });
}

/* ------------------------------------------------------------
   UI HELPERS
------------------------------------------------------------ */
const chat = txt=>{document.getElementById("chat").appendChild(txt);window.scrollTo(0,document.body.scrollHeight);}
const addMsg=(txt,cls)=>{let d=document.createElement("div");d.className="msg "+cls;d.textContent=txt;chat(d);return d;}
const streamWords=(el,text)=>new Promise(res=>{
  const w=text.split(" ");let i=0;
  const interval=setInterval(()=>{el.textContent+=w[i++]+" ";if(i>=w.length){clearInterval(interval);res();}},40);
});

/* ------------------------------------------------------------
   THEME
------------------------------------------------------------ */
document.getElementById("themeToggle").onclick=()=>document.body.classList.toggle("dark");

/* ------------------------------------------------------------
   VECTOR UTILS
------------------------------------------------------------ */
function dot(a,b){let s=0;for(let i=0;i<a.length;i++)s+=a[i]*b[i];return s;}
function norm(a){return Math.sqrt(dot(a,a));}
function cosine(a,b){return dot(a,b)/(norm(a)*norm(b));}
async function embed(text){
  const out = await llm.embed(text);
  return Array.from(out.data);
}

/* ------------------------------------------------------------
   RAG: STORE & SEARCH
------------------------------------------------------------ */
async function storeDoc(text){
  const e = await embed(text);
  const stmt = db.prepare("INSERT INTO docs(content,embedding) VALUES(?,?)");
  stmt.run([text,JSON.stringify(e)]);
  stmt.free();
}

async function searchDocs(query,k=3){
  const qemb = await embed(query);
  const stmt = db.prepare("SELECT * FROM docs");
  let results=[];
  while(stmt.step()){
    let row = stmt.getAsObject();
    let emb = JSON.parse(row.embedding);
    let score = cosine(qemb,emb);
    results.push({text:row.content,score});
  }
  stmt.free();
  return results.sort((a,b)=>b.score-a.score).slice(0,k);
}

/* ------------------------------------------------------------
   AUTO DETECT MODE
------------------------------------------------------------ */
function detectMode(text){
  if(/[\{\};=<>]/.test(text)||text.includes("function")||text.includes("class")||text.includes("import")||text.includes("console"))
    return "code";
  return "chat";
}

/* ------------------------------------------------------------
   LOCAL JS EXEC TOOL
------------------------------------------------------------ */
function runJS(code){
  try{return String(Function(code)());}
  catch(e){return "Error: "+e.message;}
}

/* ------------------------------------------------------------
   MAIN AI LOGIC
------------------------------------------------------------ */
async function process(user){
  const mode = detectMode(user);

  // RAG
  const docs = await searchDocs(user);
  const context = docs.map(d=>d.text).join("\n");

  const systemPrompt = `
You are a dual-mode assistant.
If user is coding, act as expert coding assistant.
If chatting, respond normally.
Use retrieved knowledge:\n${context}
  `;

  let prompt;
  if(mode==="code"){
    prompt = `${systemPrompt}\nUser code:\n${user}\nRespond as coding expert.`;
  } else {
    prompt = `${systemPrompt}\nUser message: ${user}`;
  }

  const msg = await llm.chat.completions.create({
    messages:[
      {role:"system",content:systemPrompt},
      {role:"user",content:prompt}
    ]
  });

  return msg.choices[0].message.content;
}

/* ------------------------------------------------------------
   SEND MESSAGE
------------------------------------------------------------ */
async function send(){
  const inp=document.getElementById("userInput");
  const text=inp.value.trim();
  if(!text)return;
  inp.value="";

  addMsg(text,"user");

  const botEl=addMsg("","bot");

  // RUN JS IF CODE SNIPPET TOOL
  if(detectMode(text)==="code" && text.startsWith("runjs:")){
    const result = runJS(text.slice(6));
    await streamWords(botEl,result);
    return;
  }

  const out = await process(text);
  await streamWords(botEl,out);
}

/* ------------------------------------------------------------
   HANDLERS
------------------------------------------------------------ */
document.getElementById("sendBtn").onclick=send;
document.getElementById("userInput").onkeydown=e=>{if(e.key==="Enter")send();};
</script>
</body>
</html>
