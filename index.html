<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen Mobile Lite</title>
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #6366f1; --coder: #10b981; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; }
        #chat-box { flex-grow: 1; overflow-y: auto; background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; font-size: 14px; }
        .controls { display: flex; gap: 8px; margin-bottom: 10px; }
        button { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        #toggle-mode { background: var(--primary); flex-grow: 1; }
        #toggle-mode.coder-mode { background: var(--coder); }
        .input-area { display: flex; gap: 8px; }
        input { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #ccc; outline: none; }
        #send-btn { background: #333; width: 60px; }
        .msg { margin-bottom: 10px; line-height: 1.4; }
        .user { color: #555; font-weight: bold; }
        .ai { color: #000; }
        .status { font-size: 10px; color: #888; text-align: center; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="status" id="status">Ready (Wasm Mode)</div>
    
    <div class="controls">
        <button id="toggle-mode">Mode: General Chat</button>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Type a message...">
        <button id="send-btn">Send</button>
    </div>

    <script type="module">
        const status = document.getElementById('status');
        const chatBox = document.getElementById('chat-box');
        const toggleBtn = document.getElementById('toggle-mode');
        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        let isCoder = false;
        let generator = null;

        const models = {
            general: 'Xenova/Qwen2.5-0.5B-Instruct',
            coder: 'Xenova/Qwen2.5-Coder-0.5B-Instruct'
        };

        // Initialize pipeline
        async function loadModel(modelName) {
            status.textContent = `Loading ${modelName} (Quantized)...`;
            toggleBtn.disabled = true;
            
            // Using 'q4' quantization for mobile memory efficiency
            generator = await transformer.pipeline('text-generation', modelName, {
                device: 'wasm', 
                quantized: true,
            });
            
            status.textContent = `${isCoder ? 'Coder' : 'General'} Model Ready`;
            toggleBtn.disabled = false;
        }

        // Toggle Logic
        toggleBtn.onclick = async () => {
            isCoder = !isCoder;
            toggleBtn.classList.toggle('coder-mode');
            toggleBtn.textContent = isCoder ? "Mode: Coder" : "Mode: General Chat";
            await loadModel(isCoder ? models.coder : models.general);
        };

        async function generateResponse() {
            const text = input.value;
            if (!text || !generator) return;

            appendMsg('User', text);
            input.value = '';
            status.textContent = "Thinking...";

            const output = await generator(text, {
                max_new_tokens: 128,
                temperature: 0.7,
            });

            appendMsg('AI', output[0].generated_text.replace(text, '').trim());
            status.textContent = "Ready";
        }

        function appendMsg(sender, text) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<span class="${sender.toLowerCase()}">${sender}:</span> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        sendBtn.onclick = generateResponse;
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') generateResponse(); });

        // Initial Load
        import * as transformer from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
        loadModel(models.general);
    </script>
</body>
</html>
