<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiny Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            line-height: 1.5;
        }
        
        /* Main App Content */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            padding: 16px;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Messages */
        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            position: relative;
            line-height: 1.6;
            font-size: 16px;
            word-wrap: break-word;
        }
        
        .user-message {
            align-self: flex-end;
            background: #333333;
            color: #ffffff;
            border-bottom-right-radius: 6px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: #222222;
            color: #ffffff;
            border-bottom-left-radius: 6px;
        }
        
        .system-message {
            align-self: center;
            background: #222222;
            color: #999999;
            max-width: 90%;
            font-style: italic;
            border-radius: 18px;
            font-size: 14px;
            padding: 10px 16px;
        }
        
        .loading-dots {
            display: inline-block;
            color: #999999;
        }
        
        .loading-dots::after {
            content: '.';
            animation: dots 1.5s infinite;
            width: 20px;
            display: inline-block;
            text-align: left;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Input Area */
        .input-area {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: #000000;
            position: relative;
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            max-width: 100%;
        }
        
        .input-field {
            flex: 1;
            background: #111111;
            border: none;
            border-radius: 24px;
            padding: 12px 16px;
            color: #ffffff;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            min-height: 44px;
            max-height: 200px;
            resize: none;
            outline: none;
            -webkit-appearance: none;
        }
        
        .input-field::placeholder {
            color: #666666;
        }
        
        .send-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .send-btn:hover {
            background: #3a56d4;
            transform: scale(1.05);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .send-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-btn i {
            font-size: 18px;
        }
        
        /* Hide default scrollbar */
        .chat-area::-webkit-scrollbar {
            display: none;
        }
        
        .chat-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">New chat</div>
        
        <div class="chat-area" id="chat-box">
            <div class="system-message">
                <strong>System:</strong> Initializing AI agent. This may take a moment as the model downloads (~113MB)...
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <textarea id="user-input" class="input-field" placeholder="Ask me anything..." disabled></textarea>
                <button id="send-btn" class="send-btn" disabled>
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Using Wllama from CDN
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Conversation history
        let conversationHistory = [];
        
        // SMART AGENT PROMPT - Minimalist but effective guidance
        // Critical: Avoid explicit "Reasoning:" tokens that leak into output
        const SYSTEM_PROMPT = `You are a helpful AI assistant named TinyAgent. Provide accurate, concise answers. Think carefully before responding. If uncertain, say "I don't have enough information to answer accurately." Never repeat phrases or instructions in your response.`;

        // Configuration for WASM binaries
        const CONFIG_PATHS = {
            'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
            'multi-thread/wllama.wasm' : 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm',
        };

        const wllama = new Wllama(CONFIG_PATHS);

        // Add message to chat UI
        function addMessage(content, role, isLoading = false) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            
            if (role === 'user') {
                messageEl.classList.add('user-message');
            } else if (role === 'ai') {
                messageEl.classList.add('ai-message');
                if (isLoading) {
                    messageEl.innerHTML = `<div class="loading-dots">${content}</div>`;
                } else {
                    // Format AI responses with paragraphs
                    const paragraphs = content.split('\n').filter(p => p.trim());
                    messageEl.innerHTML = paragraphs.map(p => `<p>${escapeHtml(p.trim())}</p>`).join('');
                }
            } else if (role === 'system') {
                messageEl.classList.add('system-message');
                messageEl.innerHTML = content;
            } else if (role === 'error') {
                messageEl.classList.add('system-message');
                messageEl.innerHTML = `<strong>Error:</strong> ${escapeHtml(content)}`;
            }
            
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (role === 'user' || role === 'ai') {
                conversationHistory.push({ role, content });
                // Keep history minimal (last 2 exchanges) for GPT-2's limited context
                if (conversationHistory.length > 4) {
                    conversationHistory.shift();
                }
            }
            
            return messageEl;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // CRITICAL FIX: Advanced cleaning specifically targeting "(1-2 sentences)" artifacts
        function cleanModelResponse(text) {
            if (!text || typeof text !== 'string') return "I don't have enough information to answer accurately.";
            
            // 1. Remove ALL special tokens immediately
            let cleaned = text
                .replace(/<\|pad\|>/g, '')
                .replace(/<\|endoftext\|>/g, '')
                .replace(/<\|unk\|>/g, '')
                .trim();
            
            // 2. AGGRESSIVE ARTIFACT REMOVAL - Target specific problematic patterns
            const artifactPatterns = [
                // Remove instruction leakage patterns
                /\([^)]*sentence[^)]*\)\.?/gi,  // "(1-2 sentences)", "(2-3 sentences)", etc.
                /\([^)]*word[^)]*\)\.?/gi,      // "(5-7 words)"
                /\([^)]*phrase[^)]*\)\.?/gi,    // "(short phrase)"
                /\(be concise\)/gi,
                /\(answer directly\)/gi,
                /\(do not repeat\)/gi,
                /\(think step by step\)/gi,
                
                // Remove meta-commentary
                /I will follow up with you.*$/gi,
                /to get a better understanding.*$/gi,
                /Let me think carefully.*$/gi,
                /First,.*?Next,.*?Finally,/gs,
                /Reasoning:.*$/gi,
                
                // Remove repetitive fragments
                /(?:\([^)]+\)\s*){2,}/g,  // Multiple parentheticals in a row
                /\.{4,}/g,                // Excessive ellipses
                /(?:, ){3,}/g             // Excessive commas
            ];
            
            for (const pattern of artifactPatterns) {
                cleaned = cleaned.replace(pattern, '');
            }
            
            // 3. Truncate at first sign of degeneration
            const badPatterns = [
                /\n\s*(?:Question|Human|User):/i,
                /<\|/,
                /\n{3,}/,
                /\(1-2 sentences\)/i,
                /I will follow up/i,
                /to get a better understanding/i
            ];
            
            for (const pattern of badPatterns) {
                const match = cleaned.match(pattern);
                if (match && match.index > 15) { // Only truncate if we have meaningful content first
                    cleaned = cleaned.substring(0, match.index).trim();
                    break;
                }
            }
            
            // 4. Remove trailing incomplete fragments
            cleaned = cleaned
                .replace(/\s+(and|but|because|although|however|though|if|when|while)$/i, '')
                .replace(/\s+I will follow up.*$/i, '')
                .replace(/\s+to get a better understanding.*$/i, '')
                .replace(/\s+let me think.*$/i, '')
                .replace(/\s+be concise.*$/i, '')
                .trim();
            
            // 5. Remove repetitions aggressively
            cleaned = cleaned.replace(/\b(\w+\s*)\1{2,}\b/gi, '$1'); // "and and and" â†’ "and"
            cleaned = cleaned.replace(/(.{10,}?)\1{1,}/g, '$1');     // Longer repetitions
            
            // 6. Final cleanup and quality enforcement
            cleaned = cleaned
                .replace(/\s+/g, ' ')
                .replace(/\n{2,}/g, ' ')
                .replace(/^[\s.,;:!?()]+|[\s.,;:!?()]+$/g, '')
                .trim();
            
            // 7. Quality checks - reject low-quality outputs
            if (
                cleaned.includes('<|') || 
                cleaned.length < 12 || 
                cleaned.split(' ').length < 4 ||
                /\(.*?\)/.test(cleaned) || // Still has parentheses artifacts
                /^(OK|Yes|No|Sure|Hmm|Well|Ah|Oh|Um|Uh)[,.!?]?$/.test(cleaned) ||
                cleaned.startsWith("I will") ||
                cleaned.startsWith("Let me") ||
                cleaned.includes("(1-2 sentences)")
            ) {
                return "I don't have enough information to answer accurately. Could you ask something more specific?";
            }
            
            // 8. Ensure proper sentence ending
            if (cleaned && !/[.!?]$/.test(cleaned.replace(/[")'\]]+$/, ''))) {
                cleaned += '.';
            }
            
            return cleaned || "I don't have enough information to answer accurately.";
        }
        
        // Build minimal, effective prompt
        function buildPrompt(userMessage) {
            // Minimal context - GPT-2 124M has very limited coherence window
            let prompt = `System: ${SYSTEM_PROMPT}\n\n`;
            
            // Only include most recent exchange for context
            if (conversationHistory.length >= 2) {
                const lastUser = conversationHistory[conversationHistory.length - 2];
                const lastAI = conversationHistory[conversationHistory.length - 1];
                if (lastUser.role === 'user' && lastAI.role === 'ai') {
                    prompt += `User: ${lastUser.content}\n`;
                    prompt += `TinyAgent: ${cleanModelResponse(lastAI.content)}\n\n`;
                }
            }
            
            // Simple, clean format the model expects
            prompt += `User: ${userMessage}\nTinyAgent:`;
            return prompt;
        }

        async function init() {
            try {
                addMessage("Initializing AI agent with precision response filtering...", "system");
                
                // Load model
                await wllama.loadModelFromHF(
                    'RichardErkhov/Arjun-G-Ravi_-_chat-GPT2-gguf', 
                    'chat-GPT2.Q4_K.gguf', 
                    {
                        progressCallback: ({ loaded, total }) => {
                            const progress = Math.round((loaded / total) * 100);
                            if (progress % 10 === 0 || progress === 100) {
                                const existing = chatBox.querySelector('.download-progress');
                                if (existing) {
                                    existing.textContent = `Downloading AI agent: ${progress}%`;
                                } else if (progress < 100) {
                                    const el = document.createElement('div');
                                    el.classList.add('system-message', 'download-progress');
                                    el.textContent = `Downloading AI agent: ${progress}%`;
                                    chatBox.appendChild(el);
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                }
                            }
                        }
                    }
                );

                addMessage("I'm ready. I provide concise, accurate answers without repetition or artifacts.", "ai");
                addMessage("ðŸ’¡ Ask clear questions like 'What is gold?' or 'Explain photosynthesis'", "system");
                
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            } catch (err) {
                const errorMsg = err.message || 'Failed to load AI agent. Try refreshing or using Chrome/Firefox.';
                addMessage(errorMsg, "error");
                console.error("Model loading error:", err);
            }
        }
        
        async function handleChat() {
            const text = userInput.value.trim();
            if (!text) return;

            // Add user message
            addMessage(text, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Show loading indicator
            const loadingEl = addMessage("Thinking...", 'ai', true);
            sendBtn.disabled = true;
            userInput.disabled = true;
            
            try {
                const prompt = buildPrompt(text);
                
                // Generate response with artifact-prevention parameters
                const response = await wllama.createCompletion(prompt, {
                    nPredict: 90,  // Shorter = more coherent for 124M model
                    sampling: { 
                        temp: 0.65,          // Balanced for accuracy
                        top_k: 30,           // Focused token selection
                        top_p: 0.88,         // Tight nucleus sampling
                        repeat_penalty: 1.6, // STRONG repetition prevention
                        frequency_penalty: 0.6 // Aggressive artifact suppression
                    }
                });
                
                // CRITICAL: Clean response with artifact-specific filters
                const cleanedResponse = cleanModelResponse(response);
                
                // Replace loading indicator with clean response
                loadingEl.remove();
                addMessage(cleanedResponse, 'ai');
                
            } catch (err) {
                console.error("Error generating response:", err);
                loadingEl.remove();
                addMessage("I couldn't formulate a clear answer. Try asking something more specific.", "ai");
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        sendBtn.addEventListener('click', handleChat);
        userInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleChat();
            }
        });
        
        // Auto-resize textarea
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(200, userInput.scrollHeight) + 'px';
        });

        // Initialize the app
        init();
    </script>
</body>
</html>

