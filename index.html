<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmolLM2 500M Tester</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; }
        #status { font-size: 0.8em; color: #0f0; margin-bottom: 10px; font-family: monospace; }
        #output { background: #111; border: 1px solid #333; padding: 10px; height: 300px; overflow-y: auto; border-radius: 8px; font-size: 14px; white-space: pre-wrap; }
        .controls { margin-top: 15px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; font-size: 16px; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; }
        button:disabled { background: #444; color: #888; }
    </style>
</head>
<body>

    <div id="status">Status: Waiting to start...</div>
    <div id="output">Welcome. SmolLM2-500M is smarter than BitNet 700M but uses a similar amount of RAM. Tapping "LOAD" will download ~350MB of weights.</div>

    <div class="controls">
        <input type="text" id="userInput" placeholder="Ask me something..." disabled>
        <button id="mainBtn">LOAD MODEL</button>
    </div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        const status = document.getElementById('status');
        const output = document.getElementById('output');
        const input = document.getElementById('userInput');
        const btn = document.getElementById('mainBtn');

        let pipe = null;

        async function init() {
            try {
                btn.disabled = true;
                status.innerText = "Status: Downloading Model (350MB)...";
                
                // Using the optimized ONNX version for browser memory safety
                pipe = await pipeline('text-generation', 'onnx-community/SmolLM2-500M-Instruct', {
                    device: 'wasm', 
                    dtype: 'q4' // 4-bit quantization for iPhone 7 RAM safety
                });

                status.innerText = "Status: Ready!";
                btn.innerText = "SEND";
                btn.disabled = false;
                input.disabled = false;
            } catch (e) {
                status.innerText = "Error: " + e.message;
            }
        }

        async function generate() {
            const text = input.value;
            if (!text || !pipe) return;

            output.innerText += `\n\nYou: ${text}\nAI: `;
            input.value = '';
            btn.disabled = true;
            status.innerText = "Status: Thinking...";

            try {
                const results = await pipe(text, { 
                    max_new_tokens: 50,
                    temperature: 0.6,
                    repetition_penalty: 1.2
                });
                output.innerText += results[0].generated_text.replace(text, '').trim();
            } catch (e) {
                output.innerText += "\n[System: Model crashed due to low memory. Refresh Safari.]";
            }

            btn.disabled = false;
            status.innerText = "Status: Ready.";
        }

        btn.onclick = () => pipe ? generate() : init();
        input.onkeypress = (e) => { if(e.key === 'Enter') generate(); };
    </script>
</body>
</html>
