<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Horde Shooter: Evolution</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; }
        #stats { font-size: 24px; text-shadow: 2px 2px #000; }
        #gold-count { color: #ffd700; }
        #boss-ui { width: 80%; height: 20px; background: #333; margin: 10px auto; display: none; border: 2px solid white; }
        #boss-bar { width: 100%; height: 100%; background: #ff0000; }
        #menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .upgrade-btn { background: #444; color: white; padding: 15px; margin: 10px; border: 2px solid #00ff88; width: 250px; cursor: pointer; text-align: left; }
        .upgrade-btn:hover { background: #555; }
        canvas { display: block; touch-action: none; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="stats">ARMY: <span id="count">1</span> | <span id="gold-count">GOLD: 0</span></div>
        <div id="boss-ui"><div id="boss-bar"></div></div>
    </div>

    <div id="menu">
        <h1>BASE CAMP</h1>
        <button class="upgrade-btn" onclick="upgrade('startSize')">START SIZE (Cost: <span id="cost0">10</span>)<br>Current: <span id="val0">1</span></button>
        <button class="upgrade-btn" onclick="upgrade('fireRate')">FIRE RATE (Cost: <span id="cost1">20</span>)<br>Current: <span id="val1">1</span></button>
        <button class="upgrade-btn" onclick="startLevel()" style="background:#00ff88; color:black; font-size:24px; text-align:center;">DEPLOY ARMY</button>
    </div>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- GAME DATA ---
        let saveData = JSON.parse(localStorage.getItem('hordeSave')) || { gold: 0, startSize: 1, fireRate: 1 };
        let goldSession = 0;
        let gameActive = false;
        let isBossActive = false;
        let bossHealth = 100;
        let units = [], enemies = [], bullets = [], gates = [], obstacles = [];

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const ROAD_WIDTH = 10;
        let playerX = 0;
        let cameraShake = 0;

        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(5, 20, 10);
        scene.add(sun);

        // Assets
        const allyGeo = new THREE.CapsuleGeometry(0.2, 0.4, 4, 8);
        const allyMat = new THREE.MeshStandardMaterial({ color: 0x00ccff });
        const enemyMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
        const bossMat = new THREE.MeshStandardMaterial({ color: 0xaa0000 });

        // --- FUNCTIONS ---
        window.startLevel = () => {
            document.getElementById('menu').style.display = 'none';
            resetGame();
            gameActive = true;
        };

        window.upgrade = (type) => {
            let cost = type === 'startSize' ? saveData.startSize * 20 : saveData.fireRate * 30;
            if(saveData.gold >= cost) {
                saveData.gold -= cost;
                saveData[type]++;
                localStorage.setItem('hordeSave', JSON.stringify(saveData));
                updateUI();
            }
        };

        function updateUI() {
            document.getElementById('gold-count').innerText = `GOLD: ${saveData.gold}`;
            document.getElementById('val0').innerText = saveData.startSize;
            document.getElementById('cost0').innerText = saveData.startSize * 20;
            document.getElementById('val1').innerText = saveData.fireRate;
            document.getElementById('cost1').innerText = saveData.fireRate * 30;
        }
        updateUI();

        function resetGame() {
            units.forEach(u => scene.remove(u));
            enemies.forEach(e => scene.remove(e));
            gates.forEach(g => scene.remove(g));
            obstacles.forEach(o => scene.remove(o));
            units = []; enemies = []; gates = []; obstacles = [];
            
            for(let i=0; i<saveData.startSize; i++) spawnUnit(0, true);
            generateLevel();
        }

        function spawnUnit(z, isAlly) {
            const m = new THREE.Mesh(allyGeo, isAlly ? allyMat : enemyMat);
            m.position.set((Math.random()-0.5)*5, 0.5, z);
            scene.add(m);
            if(isAlly) units.push(m); else enemies.push(m);
        }

        function generateLevel() {
            for(let i=1; i<40; i++) {
                let z = -i * 30;
                if(i % 4 === 0) spawnGate(z);
                else if(i % 7 === 0) spawnSaw(z);
                else spawnEnemyWave(z);
            }
            // Spawn Boss at end
            spawnBoss(-1250);
        }

        function spawnGate(z) {
            const g = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 0.1), new THREE.MeshStandardMaterial({color: 0x00ff88, transparent:true, opacity:0.6}));
            g.position.set(Math.random()>0.5?2.5:-2.5, 1.5, z);
            g.userData = { val: 5 + Math.floor(Math.random()*10), active: true };
            scene.add(g);
            gates.push(g);
        }

        function spawnSaw(z) {
            const s = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 0.2, 16), new THREE.MeshStandardMaterial({color: 0x555555}));
            s.rotation.x = Math.PI/2;
            s.position.set(0, 0.5, z);
            scene.add(s);
            obstacles.push(s);
        }

        function spawnEnemyWave(z) {
            for(let i=0; i<5; i++) spawnUnit(z - (Math.random()*5), false);
        }

        function spawnBoss(z) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(6, 10, 6), bossMat);
            b.position.set(0, 5, z);
            b.userData = { isBoss: true };
            scene.add(b);
            enemies.push(b);
        }

        // --- CONTROLS ---
        const handleInput = (x) => { playerX = ((x/window.innerWidth)-0.5) * ROAD_WIDTH * 1.5; };
        window.addEventListener('mousemove', e => handleInput(e.clientX));
        window.addEventListener('touchmove', e => handleInput(e.touches[0].clientX));

        // --- LOOP ---
        let frame = 0;
        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;
            frame++;

            const speed = isBossActive ? 0 : 0.4;
            
            units.forEach((u, i) => {
                u.position.z -= speed;
                u.position.x += (playerX + (i%5-2)*0.5 - u.position.x) * 0.1;

                // Shooting
                if(frame % Math.max(5, 40 - saveData.fireRate*5) === 0) {
                    const b = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({color:0xffff00}));
                    b.position.copy(u.position);
                    scene.add(b);
                    bullets.push(b);
                }
            });

            // Bullet Logic
            bullets.forEach((b, bi) => {
                b.position.z -= 1;
                if(b.position.z < units[0]?.position.z - 50) { scene.remove(b); bullets.splice(bi, 1); }
                
                enemies.forEach((en, ei) => {
                    if(b.position.distanceTo(en.position) < 2) {
                        if(en.userData.isBoss) {
                            bossHealth -= 0.5;
                            document.getElementById('boss-bar').style.width = bossHealth + "%";
                            if(bossHealth <= 0) { 
                                saveData.gold += 500; 
                                endGame(true); 
                            }
                        } else {
                            scene.remove(en);
                            enemies.splice(ei, 1);
                            saveData.gold += 1;
                        }
                        scene.remove(b);
                        bullets.splice(bi, 1);
                    }
                });
            });

            // Gate Collision
            gates.forEach(g => {
                if(g.userData.active && units[0] && Math.abs(units[0].position.z - g.position.z) < 0.5) {
                    if(Math.abs(playerX - g.position.x) < 2.5) {
                        g.userData.active = false; g.visible = false;
                        for(let i=0; i<g.userData.val; i++) spawnUnit(units[0].position.z, true);
                    }
                }
            });

            // Boss Trigger
            if(units[0] && units[0].position.z < -1200 && !isBossActive) {
                isBossActive = true;
                document.getElementById('boss-ui').style.display = 'block';
            }

            // Death Check
            if(units.length === 0) endGame(false);

            // UI
            document.getElementById('count').innerText = units.length;
            document.getElementById('gold-count').innerText = `GOLD: ${saveData.gold}`;

            // Camera
            if(units[0]) {
                camera.position.set(0, 15, units[0].position.z + 20);
                camera.lookAt(0, 0, units[0].position.z);
            }

            renderer.render(scene, camera);
        }

        function endGame(victory) {
            gameActive = false;
            isBossActive = false;
            localStorage.setItem('hordeSave', JSON.stringify(saveData));
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('menu').querySelector('h1').innerText = victory ? "VICTORY!" : "ARMY WIPED OUT";
            document.getElementById('boss-ui').style.display = 'none';
            updateUI();
        }

        animate();
    </script>
</body>
</html>
