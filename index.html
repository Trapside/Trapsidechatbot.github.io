<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>trapsite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap');
    
    * { 
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      color: #e6e6e6;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    
    #loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      text-align: center;
      transition: opacity 0.4s ease;
    }
    
    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #chat-interface {
      display: none;
      flex-direction: column;
      height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    #chat-interface.visible {
      display: flex;
      opacity: 1;
    }
    
    .card {
      background: rgba(30, 30, 30, 0.85);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 28px;
      padding: 40px 32px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      margin: 20px;
    }
    
    .status { 
      margin: 20px 0; 
      min-height: 24px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .status.error { color: #ff453a; }
    .status.success { color: #30d158; }
    .status.warning { color: #ffd60a; }
    .status.info { color: #5ac8fa; }
    
    .progress-container {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #0071e3, #5e5ce6);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .btn {
      background: linear-gradient(135deg, #0071e3, #0066cc);
      color: white;
      border: none;
      border-radius: 24px;
      padding: 16px;
      font-size: 17px;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 24px rgba(0, 113, 227, 0.3);
    }
    
    .btn:hover:not(:disabled) { transform: translateY(-2px); }
    .btn:active:not(:disabled) { transform: translateY(0); }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0.4); }
      70% { box-shadow: 0 0 0 12px rgba(0, 113, 227, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0); }
    }
    
    .brave-instructions {
      background: rgba(255, 149, 0, 0.1);
      border: 1px solid rgba(255, 149, 0, 0.3);
      border-radius: 16px;
      padding: 16px;
      margin-top: 20px;
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .brave-instructions ol { padding-left: 20px; margin: 8px 0; }
    .brave-instructions li { margin: 6px 0; }
    
    .logo {
      font-size: 48px;
      background: linear-gradient(90deg, #0071e3, #5e5ce6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 16px;
    }
    
    /* Chat Interface Styles */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scrollbar-width: none;
    }
    
    #chat-box::-webkit-scrollbar { display: none; }
    
    .message {
      max-width: 85%;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .glass-effect {
      background: rgba(30, 30, 30, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    }
    
    .user-message {
      margin-left: auto;
      background: linear-gradient(135deg, rgba(40, 40, 40, 0.85), rgba(35, 35, 35, 0.9));
      border-top-right-radius: 12px;
    }
    
    .ai-message {
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.75), rgba(25, 25, 25, 0.85));
      border-top-left-radius: 12px;
    }
    
    .input-area {
      padding: 16px;
      background: rgba(20, 20, 20, 0.9);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .input-container {
      background: rgba(30, 30, 30, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 32px;
      padding: 4px;
      display: flex;
      gap: 4px;
    }
    
    .input-field {
      background: transparent;
      border: none;
      color: #e6e6e6;
      font-size: 16px;
      padding: 0 16px;
      flex: 1;
      outline: none;
    }
    
    .input-field::placeholder { color: #9d9d9d; }
    
    .action-button {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #c8c8c8;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-button:hover { background: rgba(255, 255, 255, 0.1); color: #e6e6e6; }
    .action-button:active { background: rgba(255, 255, 255, 0.15); }
    
    .thinking {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #9d9d9d;
      border-radius: 50%;
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .thinking:nth-child(1) { animation-delay: -0.32s; }
    .thinking:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); } 
      40% { transform: scale(1); }
    }
    
    .model-badge {
      background: rgba(0, 113, 227, 0.15);
      color: #0071e3;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
      margin-top: 8px;
    }
    
    .timestamp {
      font-size: 11px;
      color: #9d9d9d;
      margin-top: 8px;
      text-align: right;
      opacity: 0.8;
    }
    
    .welcome-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 4px;
      background: linear-gradient(90deg, #e6e6e6, #c8c8c8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .welcome-subtitle {
      font-size: 16px;
      color: #c8c8c8;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="card">
      <i class="fas fa-brain logo"></i>
      <h1 class="text-2xl font-bold mb-2">trapsite</h1>
      <p class="text-gray-400 mb-6">Private AI running entirely in your browser</p>
      
      <div class="status info" id="status">
        <i class="fas fa-info-circle"></i>
        Checking browser compatibility...
      </div>
      
      <div class="progress-container" id="progress-container" style="display: none;">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <button class="btn pulse" id="init-btn">
        <i class="fas fa-cloud-download-alt mr-2"></i>Load AI Model
      </button>
      
      <div class="brave-instructions" id="brave-instructions" style="display: none;">
        <p class="font-medium mb-2">üõ°Ô∏è Brave Browser Setup:</p>
        <ol>
          <li>Go to <code>brave://flags</code></li>
          <li>Enable <strong>"Unsafe WebGPU"</strong></li>
          <li>Click <strong>"Relaunch"</strong></li>
          <li>After restart: Set Shields to <strong>"Standard"</strong></li>
        </ol>
      </div>
      
      <p class="text-xs text-gray-500 mt-6">
        <i class="fas fa-lock mr-1"></i> 100% Private ‚Ä¢ No data leaves your device
      </p>
    </div>
  </div>

  <!-- Chat Interface (Hidden Initially) -->
  <div id="chat-interface">
    <div style="padding: 16px; padding-bottom: 0;">
      <div style="display: flex; align-items: center; justify-content: center; padding: 12px 0;">
        <h1 class="text-xl font-semibold" style="background: linear-gradient(90deg, #0071e3, #5e5ce6); -webkit-background-clip: text; background-clip: text; color: transparent;">
          trapsite
        </h1>
        <span class="model-badge" style="margin-left: 12px;">Llama 3.2 1B</span>
      </div>
    </div>
    
    <div id="chat-box">
      <div class="ai-message glass-effect">
        <div class="welcome-title">Hello.</div>
        <div class="welcome-subtitle">I'm trapsite, your private AI assistant running entirely on your device. How can I help you today?</div>
      </div>
    </div>
    
    <div class="input-area">
      <div class="input-container">
        <button class="action-button" id="clear-btn" title="Clear chat">
          <i class="fas fa-trash"></i>
        </button>
        <input type="text" id="user-input" class="input-field" placeholder="Message trapsite..." disabled>
        <button class="action-button" id="send-btn" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // CRITICAL: Must be served over HTTPS
    if (window.location.protocol !== 'https:') {
      alert('‚ö†Ô∏è ERROR: Must be served over HTTPS!\n\nGitHub Pages provides HTTPS automatically.\nDO NOT open as local file (file://)');
      throw new Error('HTTPS required');
    }

    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    
    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const chatInterface = document.getElementById('chat-interface');
    const statusEl = document.getElementById('status');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const initBtn = document.getElementById('init-btn');
    const braveInstructions = document.getElementById('brave-instructions');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    
    // State
    let engine = null;
    let abortController = null;
    let isGenerating = false;
    let messageHistory = [];
    
    // Detect Brave browser
    const isBrave = (navigator.brave && await navigator.brave.isBrave().catch(() => false)) || 
                    navigator.userAgent.includes('Brave');
    
    if (isBrave) {
      braveInstructions.style.display = 'block';
      statusEl.innerHTML = `<i class="fas fa-shield-alt"></i> Brave detected - follow setup instructions below`;
      statusEl.className = 'status warning';
    }
    
    // Check WebGPU support
    async function checkWebGPU() {
      if (!navigator.gpu) {
        statusEl.innerHTML = `<i class="fas fa-times-circle"></i> WebGPU not supported<br><span class="text-sm">Use Chrome, Edge, or Brave with WebGPU enabled</span>`;
        statusEl.className = 'status error';
        initBtn.disabled = true;
        initBtn.classList.remove('pulse');
        initBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Not Supported';
        return false;
      }
      
      try {
        const adapter = await navigator.gpu.requestAdapter();
        if (!adapter) {
          statusEl.innerHTML = `<i class="fas fa-times-circle"></i> WebGPU unavailable<br><span class="text-sm">Check browser settings for WebGPU</span>`;
          statusEl.className = 'status error';
          return false;
        }
        
        const info = await adapter.requestAdapterInfo();
        statusEl.innerHTML = `<i class="fas fa-check-circle"></i> WebGPU ready ‚Ä¢ ${info.device || 'GPU'}`;
        statusEl.className = 'status success';
        return true;
      } catch (err) {
        console.error('WebGPU check failed:', err);
        statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> WebGPU error`;
        statusEl.className = 'status error';
        return false;
      }
    }
    
    // Initialize on load
    const webGPUAvailable = await checkWebGPU();
    if (!webGPUAvailable) {
      initBtn.disabled = true;
      initBtn.classList.remove('pulse');
    }
    
    // Initialize AI Model
    initBtn.addEventListener('click', async () => {
      initBtn.disabled = true;
      initBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Loading...`;
      initBtn.classList.remove('pulse');
      progressContainer.style.display = 'block';
      statusEl.innerHTML = '<i class="fas fa-download"></i> Starting download...';
      statusEl.className = 'status info';
      
      try {
        // Initialize engine with progress callback
        engine = await webllm.CreateMLCEngine(
          "Llama-3.2-1B-Instruct-q4f16_1-MLC",
          {
            initProgressCallback: (report) => {
              // Update status text
              let statusText = report.text;
              
              // Add helpful context during download
              if (report.progress > 0 && report.progress < 0.95) {
                const percent = Math.round(report.progress * 100);
                statusText = `Downloading model: ${percent}%<br>
                  <span class="text-sm">~500MB total ‚Ä¢ First load only</span>`;
              } else if (report.progress >= 0.95) {
                statusText = "Finalizing setup...";
              }
              
              statusEl.innerHTML = `<i class="fas fa-download"></i> ${statusText}`;
              progressBar.style.width = `${Math.round(report.progress * 100)}%`;
            }
          }
        );
        
        // SUCCESS! Initialize message history
        messageHistory = [
          { 
            role: "system", 
            content: "You are trapsite, a helpful AI assistant running locally in the user's browser. Be concise, friendly, and informative. All processing happens on the user's device privately." 
          }
        ];
        
        // Show success message
        statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Model loaded successfully!`;
        statusEl.className = 'status success';
        progressBar.style.width = '100%';
        
        // Transition to chat interface after 800ms
        setTimeout(() => {
          // Hide loading screen
          loadingScreen.classList.add('hidden');
          
          // Show chat interface
          chatInterface.classList.add('visible');
          
          // Enable chat controls
          userInput.disabled = false;
          sendBtn.disabled = false;
          clearBtn.disabled = false;
          
          // Focus input
          userInput.focus();
          
          // Add welcome message to history
          messageHistory.push({
            role: "assistant",
            content: "I'm trapsite ‚ú® Your private AI assistant running entirely on your device. How can I help you today?"
          });
        }, 800);
        
      } catch (error) {
        console.error('Model load failed:', error);
        let errorMsg = error.message || 'Unknown error';
        
        // Handle common errors with user-friendly messages
        if (errorMsg.includes('device.lost')) {
          errorMsg = 'GPU device lost. Close other tabs/apps and retry.';
        } else if (errorMsg.includes('network error') || errorMsg.includes('Failed to fetch')) {
          errorMsg = 'Download failed. Check internet and disable ad-blockers.';
        } else if (errorMsg.includes('OOM') || errorMsg.includes('out of memory')) {
          errorMsg = 'Out of memory. Close other tabs/apps and retry.';
        } else if (errorMsg.includes('CORS')) {
          errorMsg = 'CORS error. Must be served from https://';
        }
        
        statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg.substring(0, 80)}`;
        statusEl.className = 'status error';
        initBtn.disabled = false;
        initBtn.innerHTML = `<i class="fas fa-redo mr-2"></i>Retry`;
        initBtn.classList.add('pulse');
        progressContainer.style.display = 'none';
      }
    });
    
    // Chat functionality
    function getCurrentTime() {
      const now = new Date();
      return now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
    }
    
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'} glass-effect`;
      
      messageDiv.innerHTML = `
        <div>${content}</div>
        <div class="timestamp">${getCurrentTime()}</div>
      `;
      
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return messageDiv;
    }
    
    function addThinkingIndicator() {
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'message ai-message glass-effect';
      thinkingDiv.innerHTML = `
        <div class="flex space-x-1">
          <span class="thinking"></span>
          <span class="thinking"></span>
          <span class="thinking"></span>
        </div>
      `;
      chatBox.appendChild(thinkingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return thinkingDiv;
    }
    
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message || !engine || isGenerating) return;
      
      // Add user message
      addMessage(message, true);
      userInput.value = '';
      
      // Add to history
      messageHistory.push({ role: 'user', content: message });
      
      // Add thinking indicator
      const thinkingDiv = addThinkingIndicator();
      isGenerating = true;
      sendBtn.disabled = true;
      userInput.disabled = true;
      clearBtn.disabled = true;
      
      // Create abort controller
      abortController = new AbortController();
      
      try {
        // Generate response
        const chunks = await engine.chat.completions.create({
          messages: [...messageHistory],
          stream: true,
          max_tokens: 512
        }, { signal: abortController.signal });
        
        let fullResponse = '';
        let aiMessageDiv = null;
        
        for await (const chunk of chunks) {
          if (!chunk?.choices?.[0]?.delta?.content) continue;
          
          const content = chunk.choices[0].delta.content;
          fullResponse += content;
          
          // Safety limit
          if (fullResponse.length > 2000) {
            fullResponse = fullResponse.substring(0, 2000) + '... (truncated)';
            if (abortController) abortController.abort();
          }
          
          if (!aiMessageDiv) {
            // Remove thinking indicator and add real message
            chatBox.removeChild(thinkingDiv);
            aiMessageDiv = addMessage(fullResponse);
          } else {
            // Update existing message
            aiMessageDiv.querySelector('div:first-child').textContent = fullResponse;
            if (fullResponse.length % 30 === 0) {
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          }
        }
        
        // Add to history
        if (fullResponse.trim()) {
          messageHistory.push({ role: 'assistant', content: fullResponse.trim() });
        }
        
      } catch (error) {
        // Handle abort gracefully
        if (error.name === 'AbortError' || error.message?.includes('abort')) {
          console.log('Generation stopped');
          if (chatBox.contains(thinkingDiv)) {
            chatBox.removeChild(thinkingDiv);
          }
          return;
        }
        
        // Handle other errors
        console.error('Generation error:', error);
        if (chatBox.contains(thinkingDiv)) {
          chatBox.removeChild(thinkingDiv);
        }
        
        let errorMsg = 'Error generating response';
        if (error.message?.includes('device.lost')) {
          errorMsg = 'GPU error. Refresh page to continue.';
          // Reset engine state
          engine = null;
          setTimeout(() => {
            loadingScreen.classList.remove('hidden');
            chatInterface.classList.remove('visible');
            initBtn.innerHTML = '<i class="fas fa-redo mr-2"></i>Reload Model';
            initBtn.disabled = false;
            initBtn.classList.add('pulse');
          }, 1000);
        } else if (error.message) {
          errorMsg = error.message.substring(0, 60);
        }
        
        addMessage(`‚ùå ${errorMsg}`, false);
      } finally {
        isGenerating = false;
        sendBtn.disabled = false;
        userInput.disabled = false;
        clearBtn.disabled = false;
        abortController = null;
      }
    }
    
    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);
    
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    userInput.addEventListener('input', () => {
      sendBtn.disabled = !userInput.value.trim() || isGenerating;
    });
    
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all messages? The AI model will stay loaded.')) {
        // Clear chat UI
        chatBox.innerHTML = `
          <div class="ai-message glass-effect">
            <div class="welcome-title">Hello.</div>
            <div class="welcome-subtitle">I'm trapsite, your private AI assistant. How can I help you today?</div>
          </div>
        `;
        
        // Reset history (keep system prompt)
        messageHistory = [
          { 
            role: "system", 
            content: "You are trapsite, a helpful AI assistant running locally in the user's browser. Be concise, friendly, and informative. All processing happens on the user's device privately." 
          },
          {
            role: "assistant",
            content: "I'm trapsite ‚ú® Your private AI assistant running entirely on your device. How can I help you today?"
          }
        ];
      }
    });
    
    // Touch effects
    [sendBtn, clearBtn, initBtn].forEach(btn => {
      if (!btn) return;
      btn.addEventListener('touchstart', function() {
        this.style.transform = 'scale(0.95)';
      });
      
      btn.addEventListener('touchend', function() {
        this.style.transform = 'scale(1)';
      });
    });
  </script>
</body>
</html>

