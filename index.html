<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trapside AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent: #00b4ff;
            --liquid-bg: linear-gradient(135deg, #02010a 0%, #0d1127 50%, #1a0b2e 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--liquid-bg); color: #fff; height: 100vh; overflow: hidden; }

        /* Progress Bar Styles */
        #progress-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: rgba(255, 255, 255, 0.05); z-index: 1000; display: none;
        }
        #progress-fill {
            height: 100%; width: 0%; background: var(--accent);
            box-shadow: 0 0 15px var(--accent); transition: width 0.2s ease;
        }
        #load-status {
            position: fixed; top: 10px; right: 20px; font-size: 12px;
            color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
            display: none; z-index: 1001;
        }

        .container { height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 30px; display: flex; justify-content: center; position: relative; }
        .brand { font-weight: 900; font-size: 26px; letter-spacing: 3px; text-transform: uppercase; }

        .view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        #chat-box { display: flex; flex-direction: column; gap: 15px; max-width: 800px; margin: 0 auto; }

        .message { 
            max-width: 85%; padding: 15px 20px; border-radius: 20px; line-height: 1.5;
            backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            background: var(--glass); position: relative;
        }
        .user-message { align-self: flex-end; border-bottom-right-radius: 4px; border-color: rgba(0, 180, 255, 0.3); }
        .ai-message { align-self: flex-start; border-bottom-left-radius: 4px; }

        .input-area { 
            position: fixed; bottom: 30px; left: 0; right: 0; padding: 0 20px;
            display: flex; justify-content: center; gap: 10px; max-width: 800px; margin: 0 auto;
        }
        .input-container { 
            flex: 1; background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 30px;
            display: flex; align-items: center; padding: 5px 15px;
        }
        input { 
            flex: 1; background: transparent; border: none; padding: 12px;
            color: #fff; outline: none; font-size: 16px;
        }

        .btn { 
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--accent); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; flex-shrink: 0;
        }
        .model-btn { background: var(--glass); border: 1px solid var(--glass-border); }
        .model-btn.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); }
    </style>
</head>
<body>

    <div id="progress-wrapper"><div id="progress-fill"></div></div>
    <div id="load-status">Downloading Model... <span id="percent">0%</span></div>

    <div class="container">
        <div class="header"><div class="brand">Trapside</div></div>
        <div class="view" id="scroll-area"><div id="chat-box"></div></div>
        
        <div class="input-area">
            <button id="model-toggle" class="btn model-btn" title="Switch to MobiLlama-0.5B">
                <i class="fas fa-microchip"></i>
            </button>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off">
                <button id="send-btn" class="btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

        const chatBox = document.getElementById('chat-box');
        const scrollArea = document.getElementById('scroll-area');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelBtn = document.getElementById('model-toggle');
        const progWrap = document.getElementById('progress-wrapper');
        const progFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('load-status');
        const percentText = document.getElementById('percent');

        let wllama = null;
        let currentModel = 'smollm2';
        const models = {
            smollm2: { repo: 'bartowski/SmolLM2-360M-Instruct-GGUF', file: 'SmolLM2-360M-Instruct-Q4_K_M.gguf' },
            mobilama: { repo: 'bartowski/MobiLlama-0.5B-Chat-GGUF', file: 'MobiLlama-0.5B-Chat-Q4_K_M.gguf' }
        };

        function addMessage(text, role) {
            const msg = document.createElement('div');
            msg.className = `message ${role}-message`;
            msg.innerText = text;
            chatBox.appendChild(msg);
            scrollArea.scrollTop = scrollArea.scrollHeight;
            return msg;
        }

        function setLoadUI(show) {
            progWrap.style.display = show ? 'block' : 'none';
            statusText.style.display = show ? 'block' : 'none';
            userInput.disabled = show;
            sendBtn.disabled = show;
            modelBtn.disabled = show;
        }

        async function loadModel(modelKey) {
            setLoadUI(true);
            try {
                await wllama.loadModelFromHF(models[modelKey].repo, models[modelKey].file, {
                    progressCallback: ({ loaded, total }) => {
                        const p = Math.round((loaded / total) * 100);
                        progFill.style.width = p + '%';
                        percentText.innerText = p + '%';
                    }
                });
                currentModel = modelKey;
                modelBtn.classList.toggle('active', modelKey === 'mobilama');
                addMessage(`System: Using ${modelKey === 'mobilama' ? 'MobiLlama-0.5B' : 'SmolLM2-360M'}`, 'ai');
            } catch (e) {
                addMessage("Error loading model. Refresh and try again.", "ai");
            } finally {
                setLoadUI(false);
                progFill.style.width = '0%';
            }
        }

        async function init() {
            wllama = new Wllama({
                'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
                'multi-thread/wllama.wasm' : 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm',
            });
            await loadModel('smollm2');
        }

        async function handleChat() {
            const text = userInput.value.trim();
            if (!text || userInput.disabled) return;

            addMessage(text, 'user');
            userInput.value = '';
            const aiMsg = addMessage("...", 'ai');

            try {
                const prompt = `<|im_start|>system\nYou are Trapside, a helpful assistant.<|im_end|>\n<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`;
                let fullText = "";
                await wllama.createCompletion(prompt, {
                    nPredict: 500,
                    sampling: { temp: 0.7 },
                    onNewToken: (token, piece, currentText) => {
                        fullText = currentText;
                        aiMsg.innerText = fullText;
                        scrollArea.scrollTop = scrollArea.scrollHeight;
                    }
                });
            } catch (e) {
                aiMsg.innerText = "Connection lost or stopped.";
            }
        }

        modelBtn.onclick = () => loadModel(currentModel === 'smollm2' ? 'mobilama' : 'smollm2');
        sendBtn.onclick = handleChat;
        userInput.onkeydown = (e) => { if(e.key === 'Enter') handleChat(); };

        init();
    </script>
</body>
</html>
