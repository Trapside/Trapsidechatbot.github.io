<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --ios-blue: #007AFF; }
        body { background-color: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .chat-bubble { max-width: 85%; border-radius: 18px; padding: 10px 16px; font-size: 15px; line-height: 1.4; margin-bottom: 8px; }
        .user { background-color: var(--ios-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background-color: #e9e9eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        #chat-container { height: calc(100vh - 140px); overflow-y: auto; display: flex; flex-direction: column; padding: 16px; }
        .btn-ios { transition: all 0.2s; }
        .btn-ios:active { transform: scale(0.95); opacity: 0.7; }
        /* Hide scrollbar */
        #chat-container::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="safe-area-inset-bottom">

    <nav class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-semibold tracking-tight">Private AI</h1>
            <p id="status" class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Ready to Load</p>
        </div>
        <button id="clear-btn" class="text-blue-500 text-sm font-medium btn-ios">Clear Chat</button>
    </nav>

    <div id="chat-container">
        <div id="welcome-screen" class="my-auto text-center space-y-4">
            <div class="bg-blue-100 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center">
                <i class="fa-solid fa-shield-halved text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold">Privacy-First AI</h2>
            <p class="text-gray-500 text-sm px-10">This AI downloads locally to your browser. No data ever leaves your device.</p>
            <button id="init-btn" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg btn-ios">
                Download & Run Locally
            </button>
            <div id="progress-box" class="hidden px-10">
                <div class="w-full bg-gray-300 rounded-full h-1.5 mb-2">
                    <div id="progress-bar" class="bg-blue-600 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-gray-400">0%</p>
            </div>
        </div>
    </div>

    <div class="glass fixed bottom-0 w-full p-3 pb-8">
        <div id="input-area" class="hidden flex items-center gap-2 max-w-2xl mx-auto">
            <input id="user-input" type="text" placeholder="iMessage" class="flex-1 bg-gray-100 border-none rounded-full px-4 py-2 focus:outline-none text-md">
            <button id="send-btn" class="bg-blue-600 text-white w-9 h-9 rounded-full flex items-center justify-center btn-ios">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const modelId = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
        let engine;
        let chatHistory = [];

        // DOM Elements
        const initBtn = document.getElementById('init-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const progressBox = document.getElementById('progress-box');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const status = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const inputArea = document.getElementById('input-area');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');

        async function initialize() {
            initBtn.classList.add('hidden');
            progressBox.classList.remove('hidden');
            
            try {
                engine = await webllm.CreateMLCEngine(modelId, {
                    initProgressCallback: (report) => {
                        const progress = Math.round(report.progress * 100);
                        progressBar.style.width = progress + "%";
                        progressText.innerText = `Downloading Model: ${progress}%`;
                        status.innerText = "Downloading...";
                    }
                });
                
                status.innerText = "Online (Local)";
                welcomeScreen.classList.add('hidden');
                inputArea.classList.remove('hidden');
            } catch (err) {
                status.innerText = "WebGPU not supported";
                alert("Your device/browser doesn't support WebGPU. Try Chrome on Android or iOS 18+");
            }
        }

        function appendMessage(role, content) {
            const msg = document.createElement('div');
            msg.className = `chat-bubble ${role === 'user' ? 'user' : 'ai'}`;
            msg.innerText = content;
            chatContainer.appendChild(msg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return msg;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || !engine) return;

            userInput.value = "";
            chatHistory.push({ role: "user", content: text });
            appendMessage("user", text);

            const aiMsg = appendMessage("ai", "...");
            let fullAiText = "";

            const chunks = await engine.chat.completions.create({
                messages: chatHistory,
                stream: true
            });

            for await (const chunk of chunks) {
                const delta = chunk.choices[0]?.delta?.content || "";
                fullAiText += delta;
                aiMsg.innerText = fullAiText;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            chatHistory.push({ role: "assistant", content: fullAiText });
        }

        // Memory Management: Clear Chat
        clearBtn.onclick = () => {
            chatHistory = [];
            const bubbles = document.querySelectorAll('.chat-bubble');
            bubbles.forEach(b => b.remove());
            if(engine) engine.resetChat(); // Resets model KV cache to free memory
        };

        initBtn.onclick = initialize;
        sendBtn.onclick = sendMessage;
        userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
