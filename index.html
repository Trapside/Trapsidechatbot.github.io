<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiny Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            line-height: 1.5;
        }
        
        /* Main App Content */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            padding: 16px;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Messages */
        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            position: relative;
            line-height: 1.6;
            font-size: 16px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .user-message {
            align-self: flex-end;
            background: #333333;
            color: #ffffff;
            border-bottom-right-radius: 6px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: #222222;
            color: #ffffff;
            border-bottom-left-radius: 6px;
        }
        
        .system-message {
            align-self: center;
            background: #222222;
            color: #999999;
            max-width: 90%;
            font-style: italic;
            border-radius: 18px;
            font-size: 14px;
            padding: 10px 16px;
        }
        
        .loading-dots {
            display: inline-block;
            color: #999999;
        }
        
        .loading-dots::after {
            content: '.';
            animation: dots 1.5s infinite;
            width: 20px;
            display: inline-block;
            text-align: left;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Input Area */
        .input-area {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: #000000;
            position: relative;
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            max-width: 100%;
        }
        
        .input-field {
            flex: 1;
            background: #111111;
            border: none;
            border-radius: 24px;
            padding: 12px 16px;
            color: #ffffff;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            min-height: 44px;
            max-height: 200px;
            resize: none;
            outline: none;
            -webkit-appearance: none;
        }
        
        .input-field::placeholder {
            color: #666666;
        }
        
        .send-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .send-btn:hover {
            background: #3a56d4;
            transform: scale(1.05);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .send-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-btn i {
            font-size: 18px;
        }
        
        /* Hide default scrollbar */
        .chat-area::-webkit-scrollbar {
            display: none;
        }
        
        .chat-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Code block styling */
        .ai-message code {
            display: block;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }
        
        .ai-message .language-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">New chat</div>
        
        <div class="chat-area" id="chat-box">
            <div class="system-message">
                <strong>System:</strong> Initializing AI agent. This may take a moment as the model downloads (~113MB)...
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <textarea id="user-input" class="input-field" placeholder="Ask me anything..." disabled></textarea>
                <button id="send-btn" class="send-btn" disabled>
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Using Wllama from CDN
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Conversation history
        let conversationHistory = [];
        
        // Domain detection keywords
        const CODING_KEYWORDS = /\b(code|python|javascript|js|html|css|java|c\+\+|c#|ruby|go|rust|sql|algorithm|function|def|class|program|script|debug|fix this code)\b/i;
        const MATH_KEYWORDS = /\b(calculate|solve|math|equation|formula|derivative|integral|probability|statistics)\b/i;
        const STEP_KEYWORDS = /\b(step by step|how to|explain how|walk me through|break down)\b/i;
        
        // Specialized system prompts per domain
        const SYSTEM_PROMPTS = {
            general: `You are TinyAgent, a concise AI assistant. Provide accurate, direct answers without meta-commentary. Never include instructions like "(1-2 sentences)" in your response.`,
            
            coding: `You are CodeAgent, an expert programmer. When asked to write code:
1. Output ONLY valid code with no explanations
2. Use proper indentation and syntax
3. Include minimal necessary comments
4. Never add meta-text like "here is the code"
Example:
def hello():
    print("Hello")
    
User:`,
            
            math: `You are MathAgent. Solve problems step-by-step but output ONLY the final answer with minimal working. Be precise with numbers. Never add commentary like "the answer is".
Example:
User: What is 15 * 3?
MathAgent: 45

User:`,
            
            step: `You are StepAgent. Break down complex tasks into 3-4 clear, actionable steps. Number each step. Be concise but complete.
Example:
User: How to make coffee?
StepAgent: 1. Boil water in a kettle. 2. Grind coffee beans freshly. 3. Place filter in dripper and add grounds. 4. Pour hot water slowly in circles.

User:`
        };

        // Configuration for WASM binaries
        const CONFIG_PATHS = {
            'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
            'multi-thread/wllama.wasm' : 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm',
        };

        const wllama = new Wllama(CONFIG_PATHS);

        // Detect query domain for specialized handling
        function detectDomain(query) {
            const lower = query.toLowerCase();
            
            // Priority order: coding > math > step-by-step > general
            if (CODING_KEYWORDS.test(query)) return 'coding';
            if (MATH_KEYWORDS.test(query)) return 'math';
            if (STEP_KEYWORDS.test(query) || lower.includes('how to') || lower.includes('explain')) return 'step';
            
            return 'general';
        }
        
        // Add message to chat UI
        function addMessage(content, role, isLoading = false) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            
            if (role === 'user') {
                messageEl.classList.add('user-message');
                messageEl.textContent = content;
            } else if (role === 'ai') {
                messageEl.classList.add('ai-message');
                if (isLoading) {
                    messageEl.innerHTML = `<div class="loading-dots">${content}</div>`;
                } else {
                    // Detect if response contains code and format accordingly
                    if (/\bdef\b|\bfunction\b|\bconst\b|console\.log|<html>|<div>|\{.*\}|^\s*[\d\w]+\s*[:=]/.test(content)) {
                        // Simple code detection - wrap in code block
                        messageEl.innerHTML = `<span class="language-label">Code:</span><code>${escapeHtml(content.trim())}</code>`;
                    } else {
                        // Regular text with paragraph formatting
                        const paragraphs = content.split('\n').filter(p => p.trim());
                        messageEl.innerHTML = paragraphs.map(p => `<p>${escapeHtml(p.trim())}</p>`).join('');
                    }
                }
            } else if (role === 'system') {
                messageEl.classList.add('system-message');
                messageEl.innerHTML = content;
            } else if (role === 'error') {
                messageEl.classList.add('system-message');
                messageEl.innerHTML = `<strong>Error:</strong> ${escapeHtml(content)}`;
            }
            
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (role === 'user' || role === 'ai') {
                conversationHistory.push({ role, content });
                // Keep history minimal (last 2 exchanges) for GPT-2's limited context
                if (conversationHistory.length > 4) {
                    conversationHistory.shift();
                }
            }
            
            return messageEl;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Advanced cleaning with domain-aware artifact removal
        function cleanModelResponse(text, domain) {
            if (!text || typeof text !== 'string') return "I cannot provide a complete answer with my current capabilities.";
            
            // 1. Remove ALL special tokens immediately
            let cleaned = text
                .replace(/<\|pad\|>/g, '')
                .replace(/<\|endoftext\|>/g, '')
                .replace(/<\|unk\|>/g, '')
                .trim();
            
            // 2. Domain-specific cleaning
            if (domain === 'coding') {
                // For code: preserve indentation but remove meta-text
                cleaned = cleaned
                    .replace(/^(?:Sure|Here|Okay|Yes|No|User:|TinyAgent:|CodeAgent:|MathAgent:|StepAgent:).*?\n/gim, '')
                    .replace(/^(?:I can help|Let me write|Here is|Below is|This code).*?\n/gim, '')
                    .replace(/(?:
```[a-z]*\n?)/g, '') // Remove markdown code fences
                    .replace(/(?:^|\n)\s*(?:User|Human|Assistant):.*<LaTex>id_5</LaTex>/gi,
                    /to get a better understanding.*<LaTex>id_4</LaTex>/gi,
                    /First,.*?Next,.*?Finally,/gs,
                    /(?:be concise|answer directly|do not repeat)/gi,
                    /^User:.*<LaTex>id_3</LaTex>/gm
                ];
                
                for (const pattern of artifactPatterns) {
                    cleaned = cleaned.replace(pattern, '');
                }
            }
            
            // 3. Universal cleanup
            cleaned = cleaned
                .replace(/\s+/g, ' ')          // Collapse spaces
                .replace(/\n{2,}/g, '\n\n')    // Clean newlines
                .replace(/^[\s.,;:!?()]+|[\s.,;:!?()]+<LaTex>id_2</LaTex>/.test(cleaned) ||
                cleaned.startsWith("I will") ||
                cleaned.startsWith("Let me")
            ) {
                if (domain === 'coding') {
                    return "I can only provide simple code snippets. Try asking for a specific small function.";
                } else if (domain === 'math') {
                    return "I can solve basic arithmetic but not complex equations.";
                } else {
                    return "I cannot provide a complete answer with my current capabilities. Try a simpler, more specific question.";
                }
            }
            
            // 5. Ensure proper ending (non-code only)
            if (domain !== 'coding' && cleaned && !/[.!?]<LaTex>id_1</LaTex>/, ''))) {
                cleaned += '.';
            }
            
            return cleaned || "I cannot provide a complete answer with my current capabilities.";
        }
        
        // Build domain-optimized prompt
        function buildPrompt(userMessage) {
            const domain = detectDomain(userMessage);
            let prompt = `${SYSTEM_PROMPTS[domain] || SYSTEM_PROMPTS.general}\n\n`;
            
            // For coding/math: minimal context (GPT-2 struggles with complex context)
            if (domain === 'coding' || domain === 'math') {
                prompt += `${userMessage}\n${domain === 'coding' ? 'CodeAgent:' : (domain === 'math' ? 'MathAgent:' : 'TinyAgent:')}`;
                return prompt;
            }
            
            // For general: include minimal recent context
            if (conversationHistory.length >= 2) {
                const lastUser = conversationHistory[conversationHistory.length - 2];
                const lastAI = conversationHistory[conversationHistory.length - 1];
                if (lastUser.role === 'user' && lastAI.role === 'ai') {
                    prompt += `User: ${lastUser.content}\nTinyAgent: ${cleanModelResponse(lastAI.content, 'general')}\n\n`;
                }
            }
            
            prompt += `User: ${userMessage}\nTinyAgent:`;
            return prompt;
        }

        async function init() {
            try {
                addMessage("Initializing AI agent with multi-domain intelligence...", "system");
                
                // Load model
                await wllama.loadModelFromHF(
                    'RichardErkhov/Arjun-G-Ravi_-_chat-GPT2-gguf', 
                    'chat-GPT2.Q4_K.gguf', 
                    {
                        progressCallback: ({ loaded, total }) => {
                            const progress = Math.round((loaded / total) * 100);
                            if (progress % 10 === 0 || progress === 100) {
                                const existing = chatBox.querySelector('.download-progress');
                                if (existing) {
                                    existing.textContent = `Downloading AI agent: ${progress}%`;
                                } else if (progress < 100) {
                                    const el = document.createElement('div');
                                    el.classList.add('system-message', 'download-progress');
                                    el.textContent = `Downloading AI agent: ${progress}%`;
                                    chatBox.appendChild(el);
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                }
                            }
                        }
                    }
                );

                addMessage("I'm ready. I can handle general questions, simple code snippets, basic math, and step-by-step explanations.", "ai");
                addMessage("ðŸ’¡ Try: 'Write a Python function to reverse a string' or 'Explain photosynthesis in 3 steps'", "system");
                
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            } catch (err) {
                const errorMsg = err.message || 'Failed to load AI agent. Try refreshing or using Chrome/Firefox.';
                addMessage(errorMsg, "error");
                console.error("Model loading error:", err);
            }
        }
        
        async function handleChat() {
            const text = userInput.value.trim();
            if (!text) return;

            // Detect domain for specialized handling
            const domain = detectDomain(text);
            
            // Add user message
            addMessage(text, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Show domain-aware loading message
            const loadingText = domain === 'coding' ? 'Writing code...' : 
                               domain === 'math' ? 'Calculating...' : 
                               domain === 'step' ? 'Breaking down steps...' : 'Thinking...';
            const loadingEl = addMessage(loadingText, 'ai', true);
            sendBtn.disabled = true;
            userInput.disabled = true;
            
            try {
                const prompt = buildPrompt(text);
                const domain = detectDomain(text);
                
                // Domain-optimized generation parameters
                const params = {
                    nPredict: domain === 'coding' ? 100 : 85, // Slightly longer for code
                    sampling: { 
                        temp: domain === 'math' ? 0.3 : (domain === 'coding' ? 0.5 : 0.65),
                        top_k: domain === 'math' ? 20 : 30,
                        top_p: 0.88,
                        repeat_penalty: 1.65, // Strong repetition prevention
                        frequency_penalty: 0.65
                    }
                };
                
                const response = await wllama.createCompletion(prompt, params);
                const cleanedResponse = cleanModelResponse(response, domain);
                
                // Replace loading indicator with clean response
                loadingEl.remove();
                addMessage(cleanedResponse, 'ai');
                
            } catch (err) {
                console.error("Error generating response:", err);
                loadingEl.remove();
                addMessage("I couldn't formulate a clear answer. Try a simpler, more specific question.", "ai");
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        sendBtn.addEventListener('click', handleChat);
        userInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleChat();
            }
        });
        
        // Auto-resize textarea
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(200, userInput.scrollHeight) + 'px';
        });

        // Initialize the app
        init();
    </script>
</body>
</html>

