<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qwen GGUF Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/@wllama/wllama@1.23.0/dist/index.all.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #8b5cf6; --coder: #10b981; --text: #f8fafc; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Progress Bar */
        #loader-overlay { padding: 15px; background: #1e293b; border-bottom: 2px solid #334155; display: none; }
        .progress-bg { background: #334155; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        #progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.3s; }
        .status-txt { font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; }

        /* Interface */
        header { padding: 15px; background: var(--card); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.5; }
        .user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .ai { align-self: flex-start; background: #334155; border-bottom-left-radius: 4px; }
        
        .controls { padding: 15px; background: var(--card); display: flex; gap: 10px; }
        input { flex-grow: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 25px; outline: none; }
        button { border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; color: white; }
        #btn-toggle { background: #475569; font-size: 12px; }
        #btn-toggle.coder-mode { background: var(--coder); }
        #btn-send { background: var(--primary); }
    </style>
</head>
<body>

<header>
    <div id="model-name">Qwen 2.5 Chat</div>
    <button id="btn-toggle">Switch to Coder</button>
</header>

<div id="loader-overlay">
    <div class="status-txt"><span id="load-status">Downloading GGUF...</span> <span id="load-pct">0%</span></div>
    <div class="progress-bg"><div id="progress-fill"></div></div>
</div>

<div id="chat-box">
    <div class="msg ai">I am running via Wasm (GGUF). The first load will download the model to your phone's cache.</div>
</div>

<div class="controls">
    <input type="text" id="user-input" placeholder="Type a message...">
    <button id="btn-send">Send</button>
</div>

<script type="module">
    // URLs for GGUF models (using Q4_K_M quantization for balance)
    const MODELS = {
        chat: "https://huggingface.co/Qwen/Qwen2.5-0.5B-Instruct-GGUF/resolve/main/qwen2.5-0.5b-instruct-q4_k_m.gguf",
        coder: "https://huggingface.co/Qwen/Qwen2.5-Coder-0.5B-Instruct-GGUF/resolve/main/qwen2.5-coder-0.5b-instruct-q4_k_m.gguf"
    };

    let wllama = null;
    let currentMode = 'chat';

    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('user-input');
    const btnSend = document.getElementById('btn-send');
    const btnToggle = document.getElementById('btn-toggle');
    const progressFill = document.getElementById('progress-fill');
    const loadPct = document.getElementById('load-pct');
    const loaderOverlay = document.getElementById('loader-overlay');

    async function initWllama(url) {
        loaderOverlay.style.display = 'block';
        
        // If wllama already exists, shut it down before switching
        if (wllama) await wllama.exit();

        wllama = new Wllama({
            "bootstrap.js": "https://cdn.jsdelivr.net/npm/@wllama/wllama@1.23.0/dist/bootstrap.js",
            "wasm-mg.js": "https://cdn.jsdelivr.net/npm/@wllama/wllama@1.23.0/dist/wllama-main.js",
        });

        await wllama.loadModelFromUrl(url, {
            progressCallback: ({ loaded, total }) => {
                const pct = Math.round((loaded / total) * 100);
                progressFill.style.width = pct + '%';
                loadPct.textContent = pct + '%';
            }
        });

        loaderOverlay.style.display = 'none';
        appendMsg('ai', `Model loaded successfully!`);
    }

    btnToggle.onclick = async () => {
        currentMode = currentMode === 'chat' ? 'coder' : 'chat';
        btnToggle.textContent = currentMode === 'chat' ? 'Switch to Coder' : 'Switch to Chat';
        btnToggle.classList.toggle('coder-mode');
        document.getElementById('model-name').textContent = currentMode === 'chat' ? 'Qwen 2.5 Chat' : 'Qwen 2.5 Coder';
        await initWllama(MODELS[currentMode]);
    };

    async function sendMessage() {
        const text = input.value.trim();
        if (!text || !wllama) return;

        appendMsg('user', text);
        input.value = '';

        const aiMsgDiv = appendMsg('ai', '...');
        let fullResponse = '';

        await wllama.run({
            prompt: `<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`,
            nPredict: 256,
            sampling: { temp: 0.7, top_k: 40 },
            onNewToken: (token, piece, currentText) => {
                fullResponse = currentText;
                aiMsgDiv.textContent = fullResponse;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
    }

    function appendMsg(sender, text) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    btnSend.onclick = sendMessage;
    input.onkeypress = (e) => e.key === 'Enter' && sendMessage();

    // Initial load
    initWllama(MODELS.chat);
</script>

</body>
</html>
