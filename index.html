<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Smol Architect</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #080a12;
  --glass: rgba(255,255,255,0.055);
  --glass-border: rgba(255,255,255,0.10);
  --glass-top: rgba(255,255,255,0.18);
  --accent: #00d4ff;
  --amber: #ffaa00;
  --text: #eef0f8;
  --muted: rgba(255,255,255,0.35);
  --muted2: rgba(255,255,255,0.55);
  --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%; background: var(--bg);
  color: var(--text); font-family: var(--font);
  font-size: 15px; overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ Ambient blobs ‚Äî slower, softer ‚îÄ‚îÄ */
.blob {
  position: fixed; border-radius: 50%;
  filter: blur(100px); pointer-events: none; z-index: 0;
  animation: blobDrift 18s ease-in-out infinite alternate;
}
.blob-1 {
  width: 600px; height: 500px; top: -200px; left: -150px;
  background: radial-gradient(ellipse, rgba(0,212,255,0.07), transparent 70%);
  animation-duration: 22s;
}
.blob-2 {
  width: 500px; height: 400px; bottom: -150px; right: -100px;
  background: radial-gradient(ellipse, rgba(124,106,255,0.07), transparent 70%);
  animation-duration: 18s; animation-delay: -8s;
}
.blob-3 {
  width: 350px; height: 300px; top: 40%; left: 30%;
  background: radial-gradient(ellipse, rgba(255,170,0,0.04), transparent 70%);
  animation-duration: 26s; animation-delay: -4s;
}
@keyframes blobDrift {
  0%   { transform: translate(0, 0) scale(1); }
  50%  { transform: translate(30px, -20px) scale(1.05); }
  100% { transform: translate(-20px, 30px) scale(0.97); }
}

/* ‚îÄ‚îÄ App shell ‚îÄ‚îÄ */
#app {
  position: relative; z-index: 1;
  display: flex; flex-direction: column;
  height: 100dvh; max-width: 780px; margin: 0 auto;
  padding: 0 16px;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 4px 14px;
  flex-shrink: 0;
}
.header-brand { display: flex; align-items: center; gap: 10px; }
.logo {
  width: 36px; height: 36px; border-radius: 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 4px 20px rgba(0,212,255,0.1);
  display: flex; align-items: center; justify-content: center; font-size: 16px;
  backdrop-filter: blur(16px);
}
.brand-name {
  font-size: 17px; font-weight: 600; letter-spacing: -0.4px; color: #fff;
}
.brand-sub {
  font-size: 11px; color: var(--muted); letter-spacing: 0.2px; margin-top: 1px;
}
.header-right { display: flex; align-items: center; gap: 8px; }

/* Glass pill ‚Äî reusable */
.glass-pill {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 999px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  font-size: 11px; color: var(--muted2);
  transition: all 0.3s ease;
}
.glass-pill.active { border-color: rgba(0,212,255,0.3); color: var(--accent); }
.glass-pill.amber  { border-color: rgba(255,170,0,0.3);  color: var(--amber); }
.status-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--muted); transition: all 0.4s ease; flex-shrink: 0;
}
.glass-pill.active .status-dot { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
.glass-pill.loading .status-dot { background: #ffc800; box-shadow: 0 0 8px #ffc800; animation: pulse 1s infinite; }
.glass-pill.error   .status-dot { background: #ff5050; box-shadow: 0 0 8px #ff5050; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

.token-pill {
  display: none; padding: 5px 12px; border-radius: 999px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
  font-size: 11px; color: var(--muted);
  backdrop-filter: blur(20px);
}
.token-pill.warn   { color: #ffc800; border-color: rgba(255,200,0,0.2); }
.token-pill.danger { color: #ff5050; border-color: rgba(255,80,80,0.2); }

.memory-count-pill {
  display: none; cursor: pointer;
}
.memory-count-pill.visible { display: flex; }

/* ‚îÄ‚îÄ Load screen ‚îÄ‚îÄ */
#load-screen {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 24px; padding: 20px;
}
.load-card {
  width: 100%; max-width: 400px; padding: 36px 32px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 24px 60px rgba(0,0,0,0.4);
  border-radius: 28px; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  text-align: center;
}
.load-icon { font-size: 48px; margin-bottom: 18px; display: block; }
.load-title {
  font-size: 22px; font-weight: 600; color: #fff;
  letter-spacing: -0.5px; margin-bottom: 10px;
}
.load-desc {
  font-size: 13px; color: var(--muted2); line-height: 1.7; margin-bottom: 28px;
}
.load-desc code {
  color: var(--accent); background: rgba(0,212,255,0.1);
  padding: 1px 6px; border-radius: 5px; font-family: inherit;
}
.load-btn {
  width: 100%; padding: 14px;
  background: rgba(0,212,255,0.12); border: 1px solid rgba(0,212,255,0.3);
  box-shadow: inset 0 1px 0 rgba(0,212,255,0.2), 0 0 30px rgba(0,212,255,0.08);
  border-radius: 14px; color: var(--accent);
  font-family: var(--font); font-size: 15px; font-weight: 500;
  cursor: pointer; transition: all 0.22s ease;
  backdrop-filter: blur(10px);
}
.load-btn:hover {
  background: rgba(0,212,255,0.2); border-color: rgba(0,212,255,0.5);
  color: #fff; box-shadow: 0 0 40px rgba(0,212,255,0.15);
}
.load-btn:disabled { opacity: 0.35; cursor: not-allowed; }

#progress-box { width: 100%; max-width: 400px; display: none; flex-direction: column; gap: 8px; }
.prog-row { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); }
.prog-track {
  width: 100%; height: 2px;
  background: rgba(255,255,255,0.07); border-radius: 99px; overflow: hidden;
}
.prog-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), #7c6aff);
  border-radius: 99px; width: 0%; transition: width 0.4s ease;
}

/* ‚îÄ‚îÄ Mode selector ‚Äî floating pill ‚îÄ‚îÄ */
#mode-pill-wrap {
  display: none; justify-content: center; padding: 10px 0 6px; flex-shrink: 0;
}
.mode-pill-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 18px; border-radius: 999px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 4px 16px rgba(0,0,0,0.2);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  color: var(--text); font-family: var(--font); font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all 0.2s; position: relative;
}
.mode-pill-btn:hover { border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); }
.mode-pill-label { color: var(--muted); font-size: 11px; }
.mode-pill-chevron { color: var(--muted); font-size: 10px; transition: transform 0.2s; }
.mode-pill-btn.open .mode-pill-chevron { transform: rotate(180deg); }

/* Mode dropdown bloom */
.mode-dropdown {
  position: absolute; top: calc(100% + 10px); left: 50%; transform: translateX(-50%);
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 20px 60px rgba(0,0,0,0.5);
  border-radius: 18px; padding: 8px; min-width: 200px;
  backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  display: none; flex-direction: column; gap: 2px; z-index: 100;
  animation: bloomIn 0.18s ease;
}
.mode-dropdown.open { display: flex; }
@keyframes bloomIn {
  from { opacity: 0; transform: translateX(-50%) scale(0.95) translateY(-4px); }
  to   { opacity: 1; transform: translateX(-50%) scale(1)    translateY(0); }
}
.mode-option {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-radius: 11px;
  font-size: 13px; font-weight: 500; color: var(--muted2);
  cursor: pointer; transition: all 0.15s; border: 1px solid transparent;
}
.mode-option:hover { background: rgba(255,255,255,0.07); color: var(--text); }
.mode-option.active { background: rgba(0,212,255,0.08); border-color: rgba(0,212,255,0.2); color: var(--accent); }
.mode-option-icon { font-size: 16px; }

.mode-sep-line { height: 1px; background: var(--glass-border); margin: 4px 0; }
.clear-option {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-radius: 11px;
  font-size: 13px; color: rgba(255,80,80,0.7);
  cursor: pointer; transition: all 0.15s;
}
.clear-option:hover { background: rgba(255,80,80,0.07); color: #ff5050; }

/* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
#chat-area { display: none; flex-direction: column; flex: 1; overflow: hidden; }

#messages {
  flex: 1; overflow-y: auto; padding: 12px 0 8px;
  display: flex; flex-direction: column; gap: 16px;
  scrollbar-width: none;
}
#messages::-webkit-scrollbar { display: none; }

/* Empty state */
#empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 10px;
  text-align: center; padding: 40px 20px;
}
.empty-icon  { font-size: 40px; opacity: 0.25; margin-bottom: 8px; }
.empty-title { font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.18); letter-spacing: -0.3px; }
.empty-hint  { font-size: 13px; color: var(--muted); line-height: 1.6; }
.chips-row   { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 18px; }
.chip {
  padding: 7px 14px; border-radius: 999px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
  backdrop-filter: blur(20px); font-size: 12px; color: var(--muted2);
  cursor: pointer; transition: all 0.18s;
}
.chip:hover { border-color: rgba(255,255,255,0.18); color: var(--text); background: rgba(255,255,255,0.08); }

/* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
.msg { display: flex; gap: 10px; align-items: flex-end; animation: msgIn 0.24s ease; }
@keyframes msgIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.msg.user { flex-direction: row-reverse; }

/* Avatar */
.av {
  width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 13px;
  position: relative;
}
.msg.user .av {
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
}
.msg.ai .av {
  background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.2);
  box-shadow: inset 0 1px 0 rgba(0,212,255,0.25), 0 0 0 0 rgba(0,212,255,0);
  transition: box-shadow 0.4s ease;
}
/* Breathing glow on AI avatar while generating */
.msg.ai.generating .av {
  animation: breathe 1.8s ease-in-out infinite;
}
@keyframes breathe {
  0%,100% { box-shadow: inset 0 1px 0 rgba(0,212,255,0.25), 0 0 0 0 rgba(0,212,255,0); }
  50%      { box-shadow: inset 0 1px 0 rgba(0,212,255,0.25), 0 0 16px 4px rgba(0,212,255,0.25); }
}

/* Bubble */
.msg-wrap { display: flex; flex-direction: column; max-width: min(72%, 520px); }
.msg.user .msg-wrap { align-items: flex-end; }

.bubble {
  padding: 12px 16px; border-radius: 20px;
  font-size: 15px; line-height: 1.6; white-space: pre-wrap; word-break: break-word;
  position: relative; overflow: hidden;
}
/* Liquid glass light sheen on top */
.bubble::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: var(--glass-top); border-radius: 20px 20px 0 0;
}

.msg.user .bubble {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 4px 24px rgba(0,0,0,0.25);
  border-bottom-right-radius: 5px;
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
}
.msg.ai .bubble {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.09);
  box-shadow: 0 4px 24px rgba(0,0,0,0.25);
  border-bottom-left-radius: 5px;
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  transition: box-shadow 0.4s ease;
}

/* Memory hit glow ‚Äî amber rim */
.msg.ai .bubble.mem-glow {
  box-shadow: 0 4px 24px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,170,0,0.35), 0 0 20px rgba(255,170,0,0.12);
  border-color: rgba(255,170,0,0.25);
  animation: rimFade 2.5s ease forwards;
}
/* Web hit glow ‚Äî cyan rim */
.msg.ai .bubble.web-glow {
  box-shadow: 0 4px 24px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,212,255,0.35), 0 0 20px rgba(0,212,255,0.12);
  border-color: rgba(0,212,255,0.25);
  animation: rimFade 2.5s ease forwards;
}
@keyframes rimFade {
  0%   { opacity:1 }
  70%  { opacity:1 }
  100% { opacity:1 }
}

/* Source row under bubble */
.sources-row { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; padding: 0 2px; }
.source-chip {
  font-size: 10px; padding: 3px 9px; border-radius: 999px;
  background: rgba(0,212,255,0.07); border: 1px solid rgba(0,212,255,0.15);
  color: rgba(0,212,255,0.7); text-decoration: none; transition: all 0.15s;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; display: inline-block;
}
.source-chip:hover { background: rgba(0,212,255,0.14); color: var(--accent); }
.mem-chip {
  font-size: 10px; padding: 3px 9px; border-radius: 999px;
  background: rgba(255,170,0,0.07); border: 1px solid rgba(255,170,0,0.2);
  color: rgba(255,170,0,0.75); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; display: inline-block;
}
.cache-chip {
  font-size: 10px; padding: 3px 9px; border-radius: 999px;
  background: rgba(124,106,255,0.08); border: 1px solid rgba(124,106,255,0.2);
  color: rgba(180,160,255,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; display: inline-block;
}

/* Msg meta */
.msg-meta { display: flex; align-items: center; gap: 8px; margin-top: 5px; padding: 0 4px; }
.msg.user .msg-meta { flex-direction: row-reverse; }
.msg-time { font-size: 10px; color: var(--muted); }
.msg-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
.msg:hover .msg-actions { opacity: 1; }
.act-btn {
  font-size: 10px; padding: 2px 8px; border-radius: 7px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
  color: var(--muted); cursor: pointer; font-family: var(--font); transition: all 0.15s;
  backdrop-filter: blur(10px);
}
.act-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.18); }

/* Single breathing dot while generating (no triple dots) */
.breath-dot {
  display: inline-block; width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent); opacity: 0.7; margin: 4px 0;
  animation: breathDot 1.4s ease-in-out infinite;
}
@keyframes breathDot {
  0%,100% { transform: scale(1); opacity: 0.5; }
  50%     { transform: scale(1.5); opacity: 1; }
}

/* ‚îÄ‚îÄ Status strip ‚Äî tiny, below bubble, fades ‚îÄ‚îÄ */
.status-strip {
  font-size: 10px; color: var(--muted); margin-top: 4px; padding: 0 4px;
  display: flex; align-items: center; gap: 5px;
  animation: fadeStatus 0.3s ease;
}
@keyframes fadeStatus { from{opacity:0} to{opacity:1} }
.status-strip.amber { color: rgba(255,170,0,0.7); }
.status-strip.cyan  { color: rgba(0,212,255,0.7); }
.status-strip.red   { color: rgba(255,120,80,0.7); }
.status-strip.purple{ color: rgba(180,160,255,0.7); }

/* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
#input-area {
  padding: 8px 0;
  padding-bottom: max(16px, var(--safe-bottom));
  flex-shrink: 0;
}

/* Floating pill */
.input-pill {
  display: flex; align-items: flex-end; gap: 0;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 32px rgba(0,0,0,0.35);
  border-radius: 24px; padding: 10px 10px 10px 18px;
  backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
.input-pill:focus-within {
  border-color: rgba(255,255,255,0.15);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 40px rgba(0,0,0,0.4), 0 0 0 3px rgba(255,255,255,0.04);
}
.input-pill.web-on {
  border-color: rgba(0,212,255,0.25);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 40px rgba(0,0,0,0.4), 0 0 20px rgba(0,212,255,0.06);
}
.input-pill.generating {
  border-color: rgba(0,212,255,0.2);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 40px rgba(0,0,0,0.4);
  animation: pillBreathe 2s ease-in-out infinite;
}
@keyframes pillBreathe {
  0%,100% { box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 32px rgba(0,0,0,0.35), 0 0 0 rgba(0,212,255,0); }
  50%     { box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 40px rgba(0,0,0,0.4), 0 0 24px rgba(0,212,255,0.1); }
}

#user-input {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--text); font-family: var(--font); font-size: 15px;
  line-height: 1.5; resize: none; max-height: 120px; min-height: 22px; scrollbar-width: none;
}
#user-input::placeholder { color: var(--muted); }
#user-input::-webkit-scrollbar { display: none; }

/* Icon buttons inside pill */
.pill-icons {
  display: flex; align-items: center; gap: 4px; flex-shrink: 0; padding-left: 6px;
}
.pill-btn {
  width: 34px; height: 34px; border-radius: 12px; flex-shrink: 0;
  background: transparent; border: 1px solid transparent;
  color: var(--muted); cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.18s; position: relative;
}
.pill-btn:hover {
  background: rgba(255,255,255,0.07); border-color: var(--glass-border); color: var(--text);
}
.pill-btn.on {
  background: rgba(0,212,255,0.1); border-color: rgba(0,212,255,0.25); color: var(--accent);
}
.pill-btn.mem-active {
  background: rgba(255,170,0,0.1); border-color: rgba(255,170,0,0.25); color: var(--amber);
}

/* Tooltip */
.pill-btn .tt {
  position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%);
  background: rgba(10,12,24,0.9); border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px); padding: 4px 10px; border-radius: 8px;
  font-size: 10px; color: var(--text); white-space: nowrap;
  pointer-events: none; opacity: 0; transition: opacity 0.15s; font-family: var(--font);
}
.pill-btn:hover .tt { opacity: 1; }

/* Send / Stop button */
.send-btn {
  width: 34px; height: 34px; border-radius: 12px; flex-shrink: 0;
  background: rgba(0,212,255,0.15); border: 1px solid rgba(0,212,255,0.3);
  box-shadow: inset 0 1px 0 rgba(0,212,255,0.25);
  color: var(--accent); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.18s; font-size: 14px;
}
.send-btn:hover { background: rgba(0,212,255,0.25); color: #fff; box-shadow: 0 0 20px rgba(0,212,255,0.2); }
.send-btn:disabled { opacity: 0.25; cursor: not-allowed; }
.send-btn svg { width: 13px; height: 13px; }
.stop-btn {
  width: 34px; height: 34px; border-radius: 12px; flex-shrink: 0;
  background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.25);
  color: #ff5050; cursor: pointer; font-size: 12px;
  display: none; align-items: center; justify-content: center; transition: all 0.18s;
}
.stop-btn:hover { background: rgba(255,80,80,0.2); }
.stop-btn.show  { display: flex; }

/* Footer hint */
.input-footer {
  display: flex; justify-content: center; align-items: center; gap: 12px;
  margin-top: 8px; padding: 0 4px;
}
.footer-hint { font-size: 10px; color: var(--muted); opacity: 0.5; }
.footer-badge {
  font-size: 10px; color: var(--muted); display: none; align-items: center; gap: 4px;
}
.footer-badge.show { display: flex; }
.footer-badge.cyan   { color: rgba(0,212,255,0.6); }
.footer-badge.amber  { color: rgba(255,170,0,0.6); }
.footer-badge.red    { color: rgba(255,80,80,0.7); animation: pulse 1s infinite; }

/* ‚îÄ‚îÄ Memory Panel ‚Äî glass sheet ‚îÄ‚îÄ */
#memory-panel {
  display: none; position: fixed; inset: 0; z-index: 200;
}
#memory-panel.open { display: block; }

.panel-overlay {
  position: absolute; inset: 0;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
  animation: overlayIn 0.22s ease;
}
@keyframes overlayIn { from{opacity:0} to{opacity:1} }

.panel-sheet {
  position: absolute; top: 0; right: 0; bottom: 0; width: min(360px, 100vw);
  background: rgba(10,12,22,0.85); border-left: 1px solid var(--glass-border);
  box-shadow: inset 1px 0 0 var(--glass-top), -20px 0 60px rgba(0,0,0,0.5);
  backdrop-filter: blur(60px); -webkit-backdrop-filter: blur(60px);
  display: flex; flex-direction: column;
  animation: sheetIn 0.28s cubic-bezier(0.32,0.72,0,1);
}
@keyframes sheetIn { from{transform:translateX(100%)} to{transform:translateX(0)} }

.panel-handle {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 22px 16px;
  border-bottom: 1px solid var(--glass-border);
}
.panel-title { font-size: 17px; font-weight: 600; color: #fff; letter-spacing: -0.3px; }
.panel-x {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--glass); border: 1px solid var(--glass-border);
  color: var(--muted); cursor: pointer; font-size: 12px;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.panel-x:hover { background: rgba(255,80,80,0.1); border-color: rgba(255,80,80,0.3); color: #ff5050; }

.panel-scroll {
  flex: 1; overflow-y: auto; padding: 18px 22px;
  display: flex; flex-direction: column; gap: 16px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent;
}

/* Drop zone */
.drop-zone {
  border: 1.5px dashed rgba(255,170,0,0.2); border-radius: 18px;
  padding: 28px 20px; text-align: center; cursor: pointer;
  background: rgba(255,170,0,0.02);
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  transition: all 0.2s; user-select: none;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: rgba(255,170,0,0.45); background: rgba(255,170,0,0.05);
}
.drop-icon   { font-size: 28px; pointer-events: none; }
.drop-label  { font-size: 13px; color: var(--muted2); line-height: 1.6; pointer-events: none; }
.drop-label strong { color: var(--amber); }
.drop-sub    { font-size: 11px; color: var(--muted); pointer-events: none; }

/* Progress */
#mem-progress { display: none; flex-direction: column; gap: 6px; }
.mp-row   { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); }
.mp-track { width: 100%; height: 2px; background: rgba(255,255,255,0.07); border-radius: 99px; overflow: hidden; }
.mp-fill  { height: 100%; background: linear-gradient(90deg, var(--amber), #ff8800); border-radius: 99px; width: 0%; transition: width 0.3s; }

/* Stats */
#mem-stats {
  display: none; padding: 10px 14px; border-radius: 12px;
  background: rgba(255,170,0,0.05); border: 1px solid rgba(255,170,0,0.12);
  font-size: 11px; color: rgba(255,170,0,0.75); line-height: 1.6;
}

/* Section label */
.section-label {
  font-size: 10px; letter-spacing: 0.8px; text-transform: uppercase;
  color: var(--muted); padding: 0 2px;
}

/* Doc list */
.doc-list { display: flex; flex-direction: column; gap: 6px; }
.doc-item {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; border-radius: 14px;
  background: var(--glass); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top);
  backdrop-filter: blur(10px); transition: all 0.15s;
}
.doc-item:hover { border-color: rgba(255,255,255,0.15); }
.doc-item.web   { border-color: rgba(124,106,255,0.15); }
.doc-item.web:hover { border-color: rgba(124,106,255,0.28); }
.doc-ico  { font-size: 18px; flex-shrink: 0; }
.doc-info { flex: 1; min-width: 0; }
.doc-name { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.doc-meta { font-size: 10px; color: var(--muted); margin-top: 2px; }
.doc-rm {
  width: 22px; height: 22px; border-radius: 8px; flex-shrink: 0;
  background: transparent; border: 1px solid var(--glass-border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.doc-rm:hover { border-color: rgba(255,80,80,0.3); color: #ff5050; background: rgba(255,80,80,0.06); }

.panel-empty { text-align: center; color: var(--muted); font-size: 12px; line-height: 1.8; padding: 16px 0; }
.clear-all-btn {
  width: 100%; padding: 11px; border-radius: 12px;
  background: transparent; border: 1px solid rgba(255,80,80,0.15);
  color: rgba(255,80,80,0.6); font-family: var(--font); font-size: 12px;
  cursor: pointer; transition: all 0.18s;
}
.clear-all-btn:hover { background: rgba(255,80,80,0.06); border-color: rgba(255,80,80,0.3); color: #ff5050; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: rgba(12,14,26,0.9); border: 1px solid var(--glass-border);
  box-shadow: inset 0 1px 0 var(--glass-top), 0 8px 32px rgba(0,0,0,0.4);
  backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  border-radius: 12px; padding: 9px 18px;
  font-size: 13px; color: var(--text); white-space: nowrap;
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1); z-index: 999;
}
#toast.show { transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ Mobile tweaks ‚îÄ‚îÄ */
@media (max-width: 600px) {
  #app { padding: 0 12px; }
  .brand-name { font-size: 15px; }
  .bubble { font-size: 14px; padding: 10px 14px; }
  .msg-wrap { max-width: 85%; }
  .load-card { padding: 28px 22px; }
  .panel-sheet { width: 100vw; border-left: none; border-top: 1px solid var(--glass-border); border-radius: 20px 20px 0 0; top: auto; height: 85vh; animation: sheetUp 0.28s cubic-bezier(0.32,0.72,0,1); }
  @keyframes sheetUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
}
</style>
</head>
<body>
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>

<div id="app">
  <header>
    <div class="header-brand">
      <div class="logo">üß†</div>
      <div>
        <div class="brand-name">Smol Architect</div>
        <div class="brand-sub">On-Device ¬∑ 360M</div>
      </div>
    </div>
    <div class="header-right">
      <div class="token-pill" id="token-pill">0 / 2048</div>
      <div class="glass-pill memory-count-pill" id="mem-count-pill" onclick="openPanel()">
        <div class="status-dot" style="background:var(--amber);box-shadow:0 0 6px var(--amber)"></div>
        <span id="mem-count-text">0 chunks</span>
      </div>
      <div class="glass-pill" id="status-pill">
        <div class="status-dot"></div>
        <span id="status-text">Not loaded</span>
      </div>
    </div>
  </header>

  <div id="load-screen">
    <div class="load-card">
      <span class="load-icon">‚ö°</span>
      <div class="load-title">Load Your Model</div>
      <div class="load-desc">
        Runs <code>100% on-device</code>. Downloads <code>Smol_Architect_Elite_v4.gguf</code> once (~300MB) then cached forever. No server, no API key.
      </div>
      <button class="load-btn" id="load-btn" onclick="loadModel()">‚Üì Download & Run</button>
    </div>
    <div id="progress-box">
      <div class="prog-row">
        <span id="prog-label">Downloading...</span>
        <span id="prog-pct">0%</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
    </div>
  </div>

  <!-- Mode pill selector -->
  <div id="mode-pill-wrap">
    <div style="position:relative">
      <button class="mode-pill-btn" id="mode-pill-btn" onclick="toggleModeMenu()">
        <span id="mode-pill-icon">üí¨</span>
        <span class="mode-pill-label">Mode:</span>
        <span id="mode-pill-name">Chat</span>
        <span class="mode-pill-chevron">‚ñæ</span>
      </button>
      <div class="mode-dropdown" id="mode-dropdown">
        <div class="mode-option active" id="opt-chat"     onclick="setMode('chat')">    <span class="mode-option-icon">üí¨</span> Chat</div>
        <div class="mode-option"        id="opt-math"     onclick="setMode('math')">    <span class="mode-option-icon">üî¢</span> Math</div>
        <div class="mode-option"        id="opt-code"     onclick="setMode('code')">    <span class="mode-option-icon">üíª</span> Code</div>
        <div class="mode-option"        id="opt-creative" onclick="setMode('creative')"><span class="mode-option-icon">‚ú®</span> Creative</div>
        <div class="mode-sep-line"></div>
        <div class="clear-option" onclick="closeModeMenu();clearChat()">‚Ü∫ Reset conversation</div>
      </div>
    </div>
  </div>

  <div id="chat-area">
    <div id="messages">
      <div id="empty-state">
        <div class="empty-icon">üß†</div>
        <div class="empty-title">Ready to think</div>
        <div class="empty-hint">Upload docs to üìö memory ¬∑ enable üåê for live search<br>Web results auto-save for offline use</div>
        <div class="chips-row" id="chips"></div>
      </div>
    </div>

    <div id="input-area">
      <div class="input-pill" id="input-pill">
        <textarea id="user-input" placeholder="Message Smol Architect‚Ä¶" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <div class="pill-icons">
          <button class="pill-btn" id="web-btn" onclick="toggleWeb()">
            üåê<span class="tt">Web search</span>
          </button>
          <button class="pill-btn" id="mem-btn" onclick="openPanel()">
            üìö<span class="tt">Memory Base</span>
          </button>
          <button class="stop-btn" id="stop-btn" onclick="stopGen()">‚ñ†</button>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="input-footer">
        <span class="footer-hint">Enter to send ¬∑ Shift+Enter for newline</span>
        <div class="footer-badge cyan" id="web-badge">üåê web on</div>
        <div class="footer-badge amber" id="mem-badge">üìö memory on</div>
        <div class="footer-badge red" id="gen-badge">‚óè generating</div>
      </div>
    </div>
  </div>
</div>

<!-- Memory Panel -->
<div id="memory-panel">
  <div class="panel-overlay" id="panel-overlay"></div>
  <div class="panel-sheet">
    <div class="panel-handle">
      <div class="panel-title">üìö Memory Base</div>
      <button class="panel-x" id="panel-x">‚úï</button>
    </div>
    <div class="panel-scroll">
      <div class="drop-zone" id="drop-zone">
        <div class="drop-icon">üìÑ</div>
        <div class="drop-label"><strong>Click to upload</strong> or drag & drop</div>
        <div class="drop-sub">PDF & TXT ¬∑ Web results auto-save here</div>
      </div>
      <input type="file" id="file-input" accept=".pdf,.txt" multiple style="display:none">

      <div id="mem-progress">
        <div class="mp-row"><span id="mp-label">Processing‚Ä¶</span><span id="mp-pct">0%</span></div>
        <div class="mp-track"><div class="mp-fill" id="mp-fill"></div></div>
      </div>

      <div id="mem-stats"></div>

      <div id="uploaded-section" style="display:none">
        <div class="section-label">üìÑ Uploaded</div>
        <div class="doc-list" id="uploaded-list"></div>
      </div>
      <div id="webcache-section" style="display:none">
        <div class="section-label">üåê Cached web</div>
        <div class="doc-list" id="webcache-list"></div>
      </div>
      <div class="panel-empty" id="doc-empty">
        No documents yet.<br>Upload a file or turn on üåê web search ‚Äî<br>results save here automatically.
      </div>
      <button class="clear-all-btn" id="clear-all-btn" style="display:none">‚úï Clear all memory</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONFIG
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WLLAMA_VER  = "2.3.0";
const WLLAMA_CDNS = [
  `https://esm.sh/@wllama/wllama@${WLLAMA_VER}`,
  `https://cdn.jsdelivr.net/npm/@wllama/wllama@${WLLAMA_VER}/dist`
];
const MODEL_URL     = "https://huggingface.co/Trapside/Trapside/resolve/main/Smol_Architect_Elite_v4.gguf";
const MAX_CTX       = 2048;
const HISTORY_TURNS = 10;
const CHUNK_SIZE    = 400;
const CHUNK_OVERLAP = 80;
const TOP_K_CHUNKS  = 4;
const MEM_CTX_LIMIT = 1400;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let wllama       = null;
let generating   = false;
let currentMode  = 'chat';
let webSearchOn  = false;
let history      = [];
let lastAiEl     = null;
let shouldStop   = false;
let pdfJsReady   = false;
let uploadedDocs = [];
let webCacheDocs = [];
let memoryChunks = [];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODES = {
  chat: {
    icon:'üí¨', label:'Chat',
    temp:0.72, top_p:0.9, top_k:40, rep_pen:1.35, pen_freq:0.15, pen_present:0.10, maxTokens:450,
    system:`You are Smol Architect Elite, a helpful, honest, and friendly assistant.
You remember everything said earlier and refer back naturally.
Answer clearly and concisely. Be warm. Never make things up. If unsure, say so.`,
    placeholder:"Message Smol Architect‚Ä¶",
    suggestions:["What is machine learning?","Tell me a fun space fact","Explain black holes simply"]
  },
  math: {
    icon:'üî¢', label:'Math',
    temp:0.2, top_p:0.8, top_k:20, rep_pen:1.30, pen_freq:0.15, pen_present:0.10, maxTokens:500,
    system:`You are Smol Architect Elite in Math Mode. Precise step-by-step solver.
Show working clearly. Label each step. End with "Answer: X". Never skip steps.`,
    placeholder:"Enter a math problem‚Ä¶",
    suggestions:["48 cookies, sell 3/4, give 6 away. How many left?","What is 15% of 240?","Solve: 2x + 7 = 19"]
  },
  code: {
    icon:'üíª', label:'Code',
    temp:0.25, top_p:0.85, top_k:30, rep_pen:1.30, pen_freq:0.15, pen_present:0.10, maxTokens:600,
    system:`You are Smol Architect Elite in Code Mode. Precise Python assistant.
Always use proper syntax, comments, descriptive names. Format code in triple backtick python blocks.
Explain what the code does. If debugging: root cause first, then fixed code.`,
    placeholder:"Describe a coding problem‚Ä¶",
    suggestions:["Write a function to find duplicates in a list","Explain list comprehensions","Why does dividing by zero crash Python?"]
  },
  creative: {
    icon:'‚ú®', label:'Creative',
    temp:0.92, top_p:0.95, top_k:60, rep_pen:1.40, pen_freq:0.15, pen_present:0.10, maxTokens:500,
    system:`You are Smol Architect Elite in Creative Mode. Imaginative writing assistant.
Be vivid, original, engaging. Avoid cliches. Surprise the reader.
Use concrete sensory details. Commit fully.`,
    placeholder:"Give me a creative prompt‚Ä¶",
    suggestions:["Story opening: library after midnight","Explain the internet as a medieval kingdom","Poem about debugging code"]
  }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PDF.JS ‚Äî lazy loaded
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadPdfJs() {
  return new Promise((res,rej) => {
    if (pdfJsReady && typeof pdfjsLib!=='undefined') { res(pdfjsLib); return; }
    const CDN    = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
    const WORKER = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const s = document.createElement('script'); s.src = CDN;
    s.onload = () => {
      try { window.pdfjsLib.GlobalWorkerOptions.workerSrc=WORKER; pdfJsReady=true; res(window.pdfjsLib); }
      catch(e){ rej(new Error('PDF.js worker error: '+e.message)); }
    };
    s.onerror = () => rej(new Error('Failed to load PDF.js'));
    document.head.appendChild(s);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FILE READING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const readText = f => new Promise((res,rej) => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=()=>rej(new Error('Read failed')); r.readAsText(f,'UTF-8'); });
const readBuf  = f => new Promise((res,rej) => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=()=>rej(new Error('Read failed')); r.readAsArrayBuffer(f); });

async function parseTxt(file) {
  const t = await readText(file);
  if (!t||!t.trim()) throw new Error(file.name+' is empty.');
  return t;
}
async function parsePdf(file) {
  setMP(0,'Loading PDF engine‚Ä¶');
  const lib = await loadPdfJs();
  setMP(5,'Reading PDF‚Ä¶');
  const buf = await readBuf(file);
  let pdf;
  try { pdf = await lib.getDocument({data:buf}).promise; }
  catch(e){ throw new Error('Cannot parse PDF: '+e.message); }
  let text=''; const total=pdf.numPages;
  for (let i=1;i<=total;i++) {
    const pg=await pdf.getPage(i);
    const ct=await pg.getTextContent();
    text+=ct.items.map(x=>x.str).join(' ')+'\n\n';
    setMP(5+Math.round((i/total)*90),`Page ${i} / ${total}‚Ä¶`);
  }
  if (!text.trim()||text.trim().length<20) throw new Error(file.name+' has no extractable text.');
  return text;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CHUNKING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function chunkText(text, docName, docType='file') {
  const clean=text.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();
  const chunks=[]; let start=0;
  while (start<clean.length) {
    const end=Math.min(start+CHUNK_SIZE,clean.length);
    let slice=clean.slice(start,end);
    if (end<clean.length) {
      const last=Math.max(slice.lastIndexOf('. '),slice.lastIndexOf('.\n'),slice.lastIndexOf('? '),slice.lastIndexOf('! '));
      if (last>CHUNK_SIZE*0.5) slice=clean.slice(start,start+last+1);
    }
    const t=slice.trim();
    if (t.length>20) chunks.push({text:t,docName,docType});
    const adv=slice.length-CHUNK_OVERLAP;
    start+=adv>0?adv:CHUNK_SIZE;
  }
  return chunks;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RETRIEVAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SW = new Set(['a','an','the','is','it','in','on','at','to','of','and','or','but','for','with','this','that','are','was','were','be','been','have','has','had','do','does','did','will','would','could','should','may','might','not','from','by','as','if','so','what','how','when','where','who','which','i','you','he','she','we','they','me','him','her','us','them','my','your','his','its','our','their','can','just','also','about','than','then','there','here','all','one','more','some','any','no','up','out','get']);
const tok = t => t.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>2&&!SW.has(w));
function buildIDF(chunks) {
  const df={}; for (const c of chunks) for (const t of new Set(tok(c.text))) df[t]=(df[t]||0)+1;
  const N=chunks.length||1; const idf={};
  for (const [t,f] of Object.entries(df)) idf[t]=Math.log((N+1)/(f+1))+1;
  return idf;
}
function retrieve(query,topK=TOP_K_CHUNKS) {
  if (!memoryChunks.length) return [];
  const idf=buildIDF(memoryChunks); const qT=tok(query); if (!qT.length) return [];
  return memoryChunks
    .map(c=>{ const cT=tok(c.text),cS=new Set(cT); let s=0; for (const q of qT) if (cS.has(q)) s+=(idf[q]||1); return {c,s:s/Math.sqrt(cT.length+1)}; })
    .filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,topK).map(x=>x.c);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PANEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPanel()  { document.getElementById('memory-panel').classList.add('open'); }
function closePanel() { document.getElementById('memory-panel').classList.remove('open'); }

document.getElementById('panel-x').addEventListener('click', closePanel);
document.getElementById('panel-overlay').addEventListener('click', closePanel);
document.getElementById('clear-all-btn').addEventListener('click', clearMemory);

const dz = document.getElementById('drop-zone');
const fi = document.getElementById('file-input');
dz.addEventListener('click', ()=>fi.click());
dz.addEventListener('dragover',  e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave', e=>{e.preventDefault();dz.classList.remove('drag-over');});
dz.addEventListener('drop', e=>{e.preventDefault();dz.classList.remove('drag-over');const f=Array.from(e.dataTransfer.files);if(f.length)processFiles(f);});
fi.addEventListener('change', e=>{const f=Array.from(e.target.files);if(f.length)processFiles(f);fi.value='';});

async function processFiles(files) {
  for (const file of files) {
    const ext=file.name.split('.').pop().toLowerCase();
    if (!['pdf','txt'].includes(ext)){showToast('‚ö† Only PDF and TXT supported');continue;}
    if (uploadedDocs.find(d=>d.name===file.name)){showToast('‚ö† "'+file.name+'" already loaded');continue;}
    try {
      setMP(0,'Starting‚Ä¶'); let raw='';
      if (ext==='txt'){setMP(30,'Reading‚Ä¶');raw=await parseTxt(file);setMP(90,'Chunking‚Ä¶');}
      else {raw=await parsePdf(file);setMP(95,'Chunking‚Ä¶');}
      const chunks=chunkText(raw,file.name,ext);
      if (!chunks.length) throw new Error('No usable text extracted.');
      setMP(100,'Done!'); setTimeout(hideMP,600);
      uploadedDocs.push({id:Date.now()+Math.random(),name:file.name,type:ext,chunkCount:chunks.length,charCount:raw.length});
      memoryChunks.push(...chunks);
      renderDocs(); updateMemUI();
      showToast('üìö "'+file.name+'" ‚Äî '+chunks.length+' chunks indexed');
    } catch(err){ console.error(err);hideMP();showToast('‚ùå '+(err.message||'Failed: '+file.name)); }
  }
}

function removeDoc(id,bucket) {
  let doc;
  if (bucket==='upload'){doc=uploadedDocs.find(d=>d.id===id);if(doc)uploadedDocs=uploadedDocs.filter(d=>d.id!==id);}
  else {doc=webCacheDocs.find(d=>d.id===id);if(doc)webCacheDocs=webCacheDocs.filter(d=>d.id!==id);}
  if (!doc) return;
  memoryChunks=memoryChunks.filter(c=>c.docName!==doc.name);
  renderDocs(); updateMemUI();
  showToast('üóë Removed "'+doc.name+'"');
}

function clearMemory(){uploadedDocs=[];webCacheDocs=[];memoryChunks=[];renderDocs();updateMemUI();showToast('Memory cleared');}

function renderDocs() {
  const ul=document.getElementById('uploaded-list');
  const wl=document.getElementById('webcache-list');
  const us=document.getElementById('uploaded-section');
  const ws=document.getElementById('webcache-section');
  const em=document.getElementById('doc-empty');
  const cb=document.getElementById('clear-all-btn');
  ul.innerHTML=''; wl.innerHTML='';
  const hU=uploadedDocs.length>0, hW=webCacheDocs.length>0, hA=hU||hW;
  us.style.cssText=hU?'display:flex;flex-direction:column;gap:8px':'display:none';
  ws.style.cssText=hW?'display:flex;flex-direction:column;gap:8px':'display:none';
  em.style.display=hA?'none':'block';
  cb.style.display=hA?'block':'none';
  const mk=(doc,bucket)=>{
    const el=document.createElement('div');
    el.className='doc-item'+(bucket==='web'?' web':'');
    const icons={pdf:'üìï',txt:'üìÑ',web:'üåê'};
    const kb=(doc.charCount/1024).toFixed(1);
    const meta=doc.type==='web'?doc.chunkCount+' chunks ¬∑ '+kb+' KB ¬∑ '+new Date(doc.savedAt).toLocaleDateString():doc.chunkCount+' chunks ¬∑ '+kb+' KB';
    const ic=document.createElement('div');ic.className='doc-ico';ic.textContent=icons[doc.type]||'üìÑ';
    const inf=document.createElement('div');inf.className='doc-info';
    const nm=document.createElement('div');nm.className='doc-name';nm.textContent=doc.name;
    const mt=document.createElement('div');mt.className='doc-meta';mt.textContent=meta;
    inf.appendChild(nm);inf.appendChild(mt);
    const rm=document.createElement('button');rm.className='doc-rm';rm.textContent='‚úï';
    rm.addEventListener('click',()=>removeDoc(doc.id,bucket==='web'?'web':'upload'));
    el.appendChild(ic);el.appendChild(inf);el.appendChild(rm);
    return el;
  };
  for (const d of uploadedDocs) ul.appendChild(mk(d,'upload'));
  for (const d of webCacheDocs)  wl.appendChild(mk(d,'web'));
}

function updateMemUI() {
  const has=memoryChunks.length>0;
  const cp=document.getElementById('mem-count-pill');
  cp.classList.toggle('visible',has);
  document.getElementById('mem-count-text').textContent=memoryChunks.length+' chunks';
  document.getElementById('mem-btn').classList.toggle('mem-active',has);
  document.getElementById('mem-badge').classList.toggle('show',has);
  const st=document.getElementById('mem-stats');
  if (has){
    const kb=(memoryChunks.reduce((a,c)=>a+c.text.length,0)/1024).toFixed(1);
    const p=[];
    if(uploadedDocs.length) p.push(uploadedDocs.length+' file'+(uploadedDocs.length>1?'s':''));
    if(webCacheDocs.length) p.push(webCacheDocs.length+' cached web');
    st.style.display='block';
    st.textContent='üìö '+p.join(' ¬∑ ')+' ¬∑ '+memoryChunks.length+' chunks ¬∑ '+kb+' KB';
  } else { st.style.display='none'; }
}
renderDocs();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WEB CACHE SAVE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveWeb(result, title) {
  const name='üåê '+title;
  if (webCacheDocs.find(d=>d.name===name)) return false;
  const src=result.sources.map(s=>s.title+' ‚Äî '+s.url).join('\n');
  const full='=== '+title+' ===\n\n'+result.context+'\n\n--- Sources ---\n'+src;
  const chunks=chunkText(full,name,'web'); if (!chunks.length) return false;
  webCacheDocs.push({id:Date.now()+Math.random(),name,type:'web',chunkCount:chunks.length,charCount:full.length,url:result.sources[0]?.url||'',savedAt:Date.now()});
  memoryChunks.push(...chunks);
  renderDocs(); updateMemUI();
  return true;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WEB SEARCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleWeb() {
  webSearchOn=!webSearchOn;
  const btn=document.getElementById('web-btn');
  const pill=document.getElementById('input-pill');
  const badge=document.getElementById('web-badge');
  btn.classList.toggle('on',webSearchOn);
  pill.classList.toggle('web-on',webSearchOn);
  badge.classList.toggle('show',webSearchOn);
  btn.querySelector('.tt').textContent='Web search: '+(webSearchOn?'ON':'OFF');
  showToast(webSearchOn?'üåê Web ON ‚Äî results auto-save to memory':'üåê Web OFF');
}

async function fetchWeb(query) {
  try {
    const r=await fetch('https://en.wikipedia.org/w/api.php?'+new URLSearchParams({action:'query',list:'search',srsearch:query,srlimit:'3',format:'json',origin:'*'}));
    if (!r.ok) throw new Error('status '+r.status);
    const d=await r.json(); const results=d?.query?.search;
    if (!results?.length) return null;
    const topTitle=results[0].title;
    const sr=await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/'+encodeURIComponent(topTitle));
    if (!sr.ok) throw new Error('summary '+sr.status);
    const sd=await sr.json(); const extract=sd?.extract;
    if (!extract||extract.length<30) return null;
    const extra=results.slice(1,3).map(x=>x.snippet.replace(/<[^>]+>/g,'').trim()).filter(s=>s.length>20).join('\n\n');
    return {
      context:(extract+(extra?'\n\nRelated:\n'+extra:'')).substring(0,1200),
      topTitle,
      sources:[
        {title:topTitle,url:'https://en.wikipedia.org/wiki/'+encodeURIComponent(topTitle.replace(/ /g,'_'))},
        ...results.slice(1,3).map(x=>({title:x.title,url:'https://en.wikipedia.org/wiki/'+encodeURIComponent(x.title.replace(/ /g,'_'))}))
      ]
    };
  } catch(e){ console.error('Web search:',e); return null; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODE MENU
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleModeMenu() {
  const btn=document.getElementById('mode-pill-btn');
  const dd=document.getElementById('mode-dropdown');
  btn.classList.toggle('open');
  dd.classList.toggle('open');
}
function closeModeMenu() {
  document.getElementById('mode-pill-btn').classList.remove('open');
  document.getElementById('mode-dropdown').classList.remove('open');
}
document.addEventListener('click', e=>{
  const wrap=document.querySelector('#mode-pill-wrap > div');
  if (wrap&&!wrap.contains(e.target)) closeModeMenu();
});

function renderSuggestions() {
  const chips=document.getElementById('chips'); if (!chips) return;
  chips.innerHTML='';
  MODES[currentMode].suggestions.forEach(s=>{
    const c=document.createElement('button'); c.className='chip'; c.textContent=s;
    c.addEventListener('click',()=>{document.getElementById('user-input').value=s;sendMessage();});
    chips.appendChild(c);
  });
}
renderSuggestions();

function setMode(mode) {
  currentMode=mode;
  const m=MODES[mode];
  document.querySelectorAll('.mode-option').forEach(o=>o.classList.remove('active'));
  document.getElementById('opt-'+mode).classList.add('active');
  document.getElementById('mode-pill-icon').textContent=m.icon;
  document.getElementById('mode-pill-name').textContent=m.label;
  document.getElementById('user-input').placeholder=m.placeholder;
  closeModeMenu();
  renderSuggestions();
  showToast(m.icon+' '+m.label+' mode ‚Äî temp '+m.temp);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LOAD MODEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadModel() {
  const btn=document.getElementById('load-btn');
  const box=document.getElementById('progress-box');
  const pill=document.getElementById('status-pill');
  const st=document.getElementById('status-text');
  btn.disabled=true; btn.textContent='Initializing‚Ä¶';
  box.style.display='flex';
  pill.className='glass-pill loading'; st.textContent='Loading‚Ä¶';

  let Wllama=null;
  for (const base of WLLAMA_CDNS){
    try{const m=await import(base+'/src/index.js');Wllama=m.Wllama;if(Wllama)break;}
    catch(e){console.warn('CDN fail:',base,e);}
  }
  if (!Wllama){
    pill.className='glass-pill error'; st.textContent='Error';
    btn.disabled=false; btn.textContent='‚Ü∫ Retry';
    showToast('Could not load wllama ‚Äî check your connection'); return;
  }
  try {
    const base=WLLAMA_CDNS[0];
    wllama=new Wllama({
      'single-thread/wllama.js':base+'/src/single-thread/wllama.js',
      'single-thread/wllama.wasm':base+'/src/single-thread/wllama.wasm',
      'multi-thread/wllama.js':base+'/src/multi-thread/wllama.js',
      'multi-thread/wllama.wasm':base+'/src/multi-thread/wllama.wasm',
      'multi-thread/wllama.worker.mjs':base+'/src/multi-thread/wllama.worker.mjs',
    });
    st.textContent='Downloading‚Ä¶';
    await wllama.loadModelFromUrl(MODEL_URL,{
      progressCallback:({loaded,total})=>{
        const pct=total>0?Math.round((loaded/total)*100):0;
        document.getElementById('prog-fill').style.width=pct+'%';
        document.getElementById('prog-pct').textContent=pct+'%';
        document.getElementById('prog-label').textContent='Downloading‚Ä¶ '+(loaded/1048576).toFixed(0)+' / '+(total/1048576).toFixed(0)+' MB';
      },
      n_ctx:MAX_CTX, n_threads:navigator.hardwareConcurrency||4,
    });
    document.getElementById('load-screen').style.display='none';
    document.getElementById('mode-pill-wrap').style.display='flex';
    document.getElementById('chat-area').style.display='flex';
    document.getElementById('token-pill').style.display='block';
    pill.className='glass-pill active'; st.textContent='Ready';
    document.getElementById('user-input').focus();
    updateTokens();
  } catch(err){
    console.error(err);
    pill.className='glass-pill error'; st.textContent='Error';
    btn.disabled=false; btn.textContent='‚Ü∫ Retry';
    showToast('Failed to load model ‚Äî check console');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOKENS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const estTok=t=>Math.ceil(t.length/3.8);
const histTok=()=>history.reduce((n,m)=>n+estTok(m.content),0);
function updateTokens(){
  const el=document.getElementById('token-pill');
  const u=histTok(); const p=u/MAX_CTX;
  el.textContent=u+' / '+MAX_CTX;
  el.className='token-pill'+(p>0.85?' danger':p>0.65?' warn':'');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SANITIZE + PROMPT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SRE=/<\|im_(start|end)\|>/g;
const san=t=>t.replace(SRE,'').replace(/\u0000/g,'');

function buildPrompt(userText,webCtx,memCtx){
  const cfg=MODES[currentMode];
  let p='<|im_start|>system\n'+cfg.system+'<|im_end|>\n';
  for (const m of history.slice(-(HISTORY_TURNS*2)))
    p+='<|im_start|>'+m.role+'\n'+m.content+'<|im_end|>\n';
  if (memCtx) p+='<|im_start|>user\n[MEMORY BASE ‚Äî primary source. Lead with this, refine with own knowledge if needed.]\n'+memCtx+'<|im_end|>\n<|im_start|>assistant\nUnderstood.<|im_end|>\n';
  if (webCtx) p+='<|im_start|>user\n[LIVE WEB ‚Äî fresh Wikipedia info.]\n'+webCtx+'<|im_end|>\n<|im_start|>assistant\nUnderstood.<|im_end|>\n';
  p+='<|im_start|>user\n'+userText+'<|im_end|>\n<|im_start|>assistant\n';
  return p;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SEND
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMessage(){
  if (generating||!wllama) return;
  const inp=document.getElementById('user-input');
  const raw=inp.value.trim(); if (!raw) return;
  inp.value=''; inp.style.height='auto';
  const es=document.getElementById('empty-state'); if(es) es.remove();
  const safe=san(raw);
  addMsg('user',raw);
  history.push({role:'user',content:safe});
  updateTokens();
  await generate(safe);
}

function stopGen(){ if(!generating)return; shouldStop=true; showToast('‚èπ Stopped'); }

function setGenUI(on){
  const sb=document.getElementById('send-btn');
  const st=document.getElementById('stop-btn');
  sb.style.display=on?'none':'flex'; sb.disabled=on;
  st.classList.toggle('show',on);
  document.getElementById('gen-badge').classList.toggle('show',on);
  document.getElementById('input-pill').classList.toggle('generating',on);
  if (lastAiEl) lastAiEl.classList.toggle('generating',on);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GENERATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generate(sanitizedText){
  generating=true; shouldStop=false; setGenUI(true);
  const cfg=MODES[currentMode];
  const aiEl=addMsg('ai',null,true);
  lastAiEl=aiEl;
  const bubble=aiEl.querySelector('.bubble');
  const metaRow=aiEl.querySelector('.msg-meta');
  bubble.innerHTML='';

  // ‚îÄ‚îÄ Memory retrieval ‚îÄ‚îÄ
  let memCtx=null, matched=[];
  if (memoryChunks.length){
    matched=retrieve(sanitizedText,TOP_K_CHUNKS);
    if (matched.length){
      let ctx='';
      for (const c of matched){ const s='[From: '+c.docName+']\n'+c.text+'\n\n'; if(ctx.length+s.length>MEM_CTX_LIMIT)break; ctx+=s; }
      memCtx=ctx.trim();
    }
  }

  // ‚îÄ‚îÄ Web search ‚îÄ‚îÄ
  let webResult=null, usedCache=false;

  if (webSearchOn){
    // Show small status strip below bubble
    const strip=document.createElement('div');
    strip.className='status-strip cyan'; strip.textContent='üîç Searching Wikipedia‚Ä¶';
    metaRow.before(strip);
    scrollBot();

    webResult=await fetchWeb(sanitizedText);

    if (webResult&&webResult.context){
      const saved=saveWeb(webResult,webResult.topTitle);
      strip.textContent='‚Üó Wikipedia ¬∑ '+(saved?'saved to memory':'already cached');
      bubble.classList.add('web-glow');
      setTimeout(()=>bubble.classList.remove('web-glow'),3000);
      // Source chips
      const row=document.createElement('div'); row.className='sources-row';
      webResult.sources.forEach(s=>{
        const a=document.createElement('a'); a.className='source-chip';
        a.href=s.url; a.target='_blank'; a.rel='noopener noreferrer';
        a.textContent='‚Üó '+s.title; row.appendChild(a);
      });
      metaRow.before(row);
    } else {
      const cachedHits=matched.filter(c=>c.docType==='web');
      if (cachedHits.length){
        usedCache=true;
        strip.className='status-strip purple';
        strip.textContent='‚ö° Offline ‚Äî from memory cache';
        const row=document.createElement('div'); row.className='sources-row';
        [...new Set(cachedHits.map(c=>c.docName))].forEach(name=>{
          const ch=document.createElement('span'); ch.className='cache-chip'; ch.textContent=name; row.appendChild(ch);
        });
        metaRow.before(row);
      } else {
        strip.className='status-strip red';
        strip.textContent='‚ö† No web access ‚Äî using model knowledge';
      }
      setTimeout(()=>strip.remove(),4000);
    }
  } else if (memCtx){
    const fromWeb=matched.some(c=>c.docType==='web');
    bubble.classList.add('mem-glow');
    setTimeout(()=>bubble.classList.remove('mem-glow'),3000);
    const strip=document.createElement('div');
    strip.className='status-strip amber';
    strip.textContent=(fromWeb?'üìö From cached web ¬∑ ':'üìö From memory ¬∑ ')+matched.length+' passage'+(matched.length>1?'s':'');
    metaRow.before(strip);
    const row=document.createElement('div'); row.className='sources-row';
    [...new Set(matched.map(c=>c.docName))].forEach(name=>{
      const ch=document.createElement('span');
      ch.className=name.startsWith('üåê')?'cache-chip':'mem-chip';
      ch.textContent=name; row.appendChild(ch);
    });
    metaRow.before(row);
  }

  // Breathing dot while waiting
  const dot=document.createElement('div'); dot.className='breath-dot';
  bubble.appendChild(dot);
  const textNode=document.createElement('span');
  bubble.appendChild(textNode);

  try {
    const prompt=buildPrompt(sanitizedText,webResult?.context||null,memCtx);
    let full='';
    await wllama.createCompletion(prompt,{
      nPredict:cfg.maxTokens,
      sampling:{temp:cfg.temp,top_p:cfg.top_p,top_k:cfg.top_k,penalty_repeat:cfg.rep_pen,penalty_freq:cfg.pen_freq,penalty_present:cfg.pen_present},
      onNewToken:(_t,_p,cur)=>{
        full=cur;
        if(dot.parentNode) dot.remove();
        textNode.textContent=cur; scrollBot();
        if(shouldStop) return false;
      },
    });
    const final=full.trim()||'(no response ‚Äî try rephrasing)';
    textNode.textContent=final;
    history.push({role:'assistant',content:shouldStop?final+' [stopped]':final});
    updateTokens();
  } catch(err){
    if (!shouldStop){ console.error(err); textNode.textContent='Generation error.'; showToast('Error ‚Äî check console'); }
  } finally {
    generating=false; shouldStop=false; setGenUI(false);
    if(dot.parentNode) dot.remove();
    if(lastAiEl) lastAiEl.classList.remove('generating');
    document.getElementById('user-input').focus(); scrollBot();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REGEN / COPY / CLEAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function regenLast(){
  if(generating||!wllama)return;
  if(history.length>0&&history[history.length-1].role==='assistant') history.pop();
  const uMsg=history.length>0&&history[history.length-1].role==='user'?history[history.length-1].content:'';
  if(lastAiEl?.parentNode) lastAiEl.remove();
  else {const all=document.getElementById('messages').querySelectorAll('.msg.ai');if(all.length)all[all.length-1].remove();}
  lastAiEl=null;
  if(uMsg) await generate(uMsg);
}

function copyMsg(btn){
  const span=btn.closest('.msg').querySelector('.bubble span');
  if(!span)return;
  navigator.clipboard.writeText(span.textContent);
  btn.textContent='copied!'; setTimeout(()=>{btn.textContent='copy';},1200);
}

function clearChat(){
  history=[]; lastAiEl=null;
  document.getElementById('messages').innerHTML=`
    <div id="empty-state">
      <div class="empty-icon">üß†</div>
      <div class="empty-title">Ready to think</div>
      <div class="empty-hint">Upload docs to üìö memory ¬∑ enable üåê for live search</div>
      <div class="chips-row" id="chips"></div>
    </div>`;
  renderSuggestions(); updateTokens();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMP(pct,label){
  document.getElementById('mem-progress').style.display='flex';
  document.getElementById('mp-fill').style.width=pct+'%';
  document.getElementById('mp-pct').textContent=pct+'%';
  document.getElementById('mp-label').textContent=label;
}
function hideMP(){ document.getElementById('mem-progress').style.display='none'; }

function addMsg(role,text,typing){
  const msgs=document.getElementById('messages');
  const el=document.createElement('div'); el.className='msg '+role;
  const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  if(typing){
    el.innerHTML=
      '<div class="av">üß†</div>'+
      '<div class="msg-wrap"><div class="bubble"></div>'+
      '<div class="msg-meta">'+
        '<span class="msg-time">'+now+'</span>'+
        '<div class="msg-actions">'+
          '<button class="act-btn" onclick="regenLast()">‚Ü∫ regen</button>'+
          '<button class="act-btn" onclick="copyMsg(this)">copy</button>'+
        '</div>'+
      '</div></div>';
  } else {
    el.innerHTML=
      '<div class="av">'+(role==='user'?'üë§':'üß†')+'</div>'+
      '<div class="msg-wrap"><div class="bubble"></div>'+
      '<div class="msg-meta"><span class="msg-time">'+now+'</span></div></div>';
    el.querySelector('.bubble').textContent=text;
  }
  msgs.appendChild(el); scrollBot(); return el;
}

function scrollBot(){ const m=document.getElementById('messages'); m.scrollTop=m.scrollHeight; }
function handleKey(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function showToast(msg,dur=2600){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GLOBALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.loadModel    = loadModel;
window.sendMessage  = sendMessage;
window.handleKey    = handleKey;
window.autoResize   = autoResize;
window.setMode      = setMode;
window.clearChat    = clearChat;
window.regenLast    = regenLast;
window.copyMsg      = copyMsg;
window.toggleWeb    = toggleWeb;
window.stopGen      = stopGen;
window.openPanel    = openPanel;
window.toggleModeMenu = toggleModeMenu;
</script>
</body>
</html>
