<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Chat GPT-2 (124M)</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f4f9; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-top: 0; font-size: 1.2rem; }
        #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 8px; background: #fafafa; font-size: 0.9rem; white-space: pre-wrap; }
        .input-area { display: flex; gap: 10px; }
        textarea { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: none; height: 50px; font-family: inherit; }
        button { padding: 0 20px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { font-size: 0.8rem; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Tiny Chat (GPT-2 124M)</h2>
    <div id="status">Status: Initializing...</div>
    <div id="chat-box">System: Waiting for model to load...</div>
    
    <div class="input-area">
        <textarea id="user-input" placeholder="Type a simple question (e.g., What is Python?)" disabled></textarea>
        <button id="send-btn" disabled>Chat</button>
    </div>
</div>

<script type="module">
    // Using Wllama from CDN
    import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

    const statusEl = document.getElementById('status');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // Configuration for WASM binaries
    const CONFIG_PATHS = {
        'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
        'multi-thread/wllama.wasm' : 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm',
    };

    const wllama = new Wllama(CONFIG_PATHS);

    async function init() {
        try {
            statusEl.innerText = "Status: Downloading model (~113MB)...";
            
            // Loading the specific GGUF model you requested
            await wllama.loadModelFromHF(
                'RichardErkhov/Arjun-G-Ravi_-_chat-GPT2-gguf', 
                'chat-GPT2.Q4_K.gguf', 
                {
                    progressCallback: ({ loaded, total }) => {
                        const progress = Math.round((loaded / total) * 100);
                        statusEl.innerText = `Status: Downloading ${progress}%`;
                    }
                }
            );

            statusEl.innerText = "Status: Ready!";
            chatBox.innerText = "System: Model loaded. Note: This is an 82M model, so keep questions simple!";
            userInput.disabled = false;
            sendBtn.disabled = false;
        } catch (err) {
            statusEl.innerText = "Status: Error loading model.";
            console.error(err);
        }
    }

    async function handleChat() {
        const text = userInput.value.trim();
        if (!text) return;

        userInput.value = '';
        sendBtn.disabled = true;
        chatBox.innerText += `\n\nYou: ${text}\n\nAI: ...`;

        // Arjun-G-Ravi model likes the "Question: Answer:" format
        const prompt = `Question: ${text} Answer:`;

        const response = await wllama.createCompletion(prompt, {
            nPredict: 100,
            sampling: { temp: 0.7, top_k: 40 }
        });

        // Append only the new response text
        chatBox.innerText = chatBox.innerText.replace('AI: ...', `AI: ${response.trim()}`);
        sendBtn.disabled = false;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener('click', handleChat);
    userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleChat(); });

    init();
</script>

</body>
</html>
