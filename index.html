<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trapside Pro</title>
    <script type="importmap"> { "imports": { "@mlc-ai/web-llm": "https://esm.run/@mlc-ai/web-llm" } } </script>
    <style>
        :root { 
            --apple-blue: #007AFF; --apple-red: #FF3B30; --bg: #F2F2F7; 
            --card-bg: rgba(255, 255, 255, 0.82); --text: #1d1d1f; 
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        .app { width: 100%; max-width: 500px; height: 100vh; background: var(--card-bg); backdrop-filter: blur(40px); display: flex; flex-direction: column; position: relative; }
        
        /* Header & Notch Awareness */
        header { padding: calc(var(--safe-top) + 12px) 20px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.5); z-index: 10; }
        .btn-ghost { background: none; border: none; color: var(--apple-blue); font-weight: 600; font-size: 15px; cursor: pointer; }

        /* Chat System */
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; padding-bottom: 140px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 16px; line-height: 1.4; max-width: 85%; animation: spring 0.4s ease; word-wrap: break-word; }
        .ai { background: white; align-self: flex-start; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-bottom-left-radius: 4px; }
        .user { background: var(--apple-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        /* Visuals */
        .gen-img { width: 100%; border-radius: 14px; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block; opacity: 0; transition: opacity 0.5s; }
        
        /* UI Components */
        #scrollBtn { position: absolute; bottom: 110px; right: 20px; width: 42px; height: 42px; background: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 0.5px solid rgba(0,0,0,0.1); z-index: 5; font-size: 18px; }
        #scrollBtn.pulse { animation: alertPulse 1.5s infinite; color: var(--apple-blue); border-color: var(--apple-blue); }

        .input-box { position: absolute; bottom: 0; width: 100%; padding-bottom: calc(var(--safe-bottom) + 15px); background: linear-gradient(transparent, var(--bg) 40%); z-index: 10; }
        .bar { margin: 0 20px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; border: none; padding: 14px 20px; border-radius: 30px; background: white; font-size: 16px; outline: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        #send { background: var(--apple-blue); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; font-weight: bold; }

        /* Loader Overlay */
        .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--apple-blue); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes alertPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 15px rgba(0,122,255,0.4); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spring { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loader" class="overlay">
    <div class="spinner"></div>
    <p id="status" style="margin-top:20px; font-size:13px; font-weight:700; color:#888; text-transform:uppercase;">Syncing Core...</p>
</div>

<div class="app">
    <header>
        <button class="btn-ghost" onclick="location.reload()">Reset</button>
        <div style="font-weight:900; letter-spacing:-0.5px;">TRAPSIDE <span style="color:var(--apple-blue);">PRO</span></div>
        <button class="btn-ghost" onclick="toggleVault()">Vault</button>
    </header>

    <div id="chat">
        <div class="msg ai">Nominal, sir. I have <b>Visuals</b> and <b>Web Access</b>. Try /imagine or /search.</div>
    </div>

    <div id="scrollBtn" onclick="scrollToBottom()">↓</div>

    <div class="input-box">
        <div class="bar">
            <input type="text" id="userInput" placeholder="Command, /imagine, or /search...">
            <button id="send">↑</button>
        </div>
    </div>
</div>

<script type="module">
    import * as webllm from "@mlc-ai/web-llm";

    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('send');
    const loader = document.getElementById('loader');
    const statusTxt = document.getElementById('status');
    const scrollBtn = document.getElementById('scrollBtn');

    let history = [];
    let isWorking = false;
    let vault = JSON.parse(localStorage.getItem('trapside_vault')) || { traits: ["Technology"] };

    // --- SYSTEM LOGIC ---
    const isAtBottom = () => chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
    window.scrollToBottom = () => chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });

    chat.onscroll = () => {
        if (isAtBottom()) { scrollBtn.style.display = 'none'; scrollBtn.classList.remove('pulse'); }
        else { scrollBtn.style.display = 'flex'; }
    };

    function append(role, text) {
        const b = document.createElement('div');
        b.className = `msg ${role}`;
        b.innerHTML = text;
        chat.appendChild(b);
        if (!isAtBottom()) scrollBtn.classList.add('pulse');
        else scrollToBottom();
        return b;
    }

    // --- CORE TOOLS ---
    async function toolImagine(prompt) {
        statusTxt.innerText = "Generating Visual...";
        loader.style.display = 'flex';
        const seed = Math.floor(Math.random() * 10000);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true&seed=${seed}`;
        
        append('ai', `Visualizing "${prompt}" for you, sir.`);
        const img = document.createElement('img');
        img.className = 'gen-img';
        img.src = url;
        img.onload = () => { img.style.opacity = 1; loader.style.display = 'none'; scrollToBottom(); };
        chat.lastElementChild.appendChild(img);
    }

    async function toolSearch(query) {
        statusTxt.innerText = "Satellite Search...";
        loader.style.display = 'flex';
        try {
            // Using DuckDuckGo API for clean snippet retrieval
            const res = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`);
            const data = await res.json();
            const intel = data.AbstractText || "No immediate summary available, scanning deeper...";
            history.push({ role: "system", content: `LIVE INTEL on ${query}: ${intel}` });
            append('ai', `Sir, I've gathered intel on ${query}. It seems: ${intel}`);
        } catch (e) {
            append('ai', "Satellite link lost. Search failed.");
        } finally { loader.style.display = 'none'; }
    }

    // --- METHOD 4 ENGINE ---
    async function handleCommand() {
        if (isWorking) return;
        const val = input.value.trim();
        if (!val) return;

        input.value = '';
        append('user', val);

        if (val.startsWith('/imagine ')) return toolImagine(val.replace('/imagine ', ''));
        if (val.startsWith('/search ')) return toolSearch(val.replace('/search ', ''));

        isWorking = true;
        sendBtn.innerText = '●';

        try {
            const engine = await webllm.CreateMLCEngine("Qwen2.5-0.5B-Instruct-q4f16_1-MLC", {
                initProgressCallback: (p) => {
                    if (p.progress < 1) {
                        loader.style.display = 'flex';
                        statusTxt.innerText = `Calibrating: ${Math.round(p.progress*100)}%`;
                    } else loader.style.display = 'none';
                }
            });

            const sys = `You are Trapside (JARVIS persona). Call user 'sir'. User traits: ${vault.traits.join(", ")}.`;
            const reply = await engine.chat.completions.create({
                messages: [{role: "system", content: sys}, ...history, {role: "user", content: val}]
            });

            const text = reply.choices[0].message.content;
            append('ai', text);
            history.push({role: "user", content: val}, {role: "assistant", content: text});
            if (history.length > 6) history.shift();

            // TRAIT LEARNING (Strict 7)
            const learn = await engine.chat.completions.create({
                messages: [{role: "user", content: `Identify 1 interest from "${val}". Reply with 1 word or 'none'.`}]
            });
            const fresh = learn.choices[0].message.content.trim().replace(/[^\w]/g, '');
            if (fresh.length > 2 && fresh.toLowerCase() !== 'none' && !vault.traits.includes(fresh)) {
                vault.traits.push(fresh);
                if (vault.traits.length > 7) vault.traits.shift();
                localStorage.setItem('trapside_vault', JSON.stringify(vault));
            }

            await engine.unload(); // THE PURGE
        } finally {
            isWorking = false;
            sendBtn.innerText = '↑';
            loader.style.display = 'none';
        }
    }

    sendBtn.onclick = handleCommand;
    input.onkeypress = (e) => { if(e.key === 'Enter') handleCommand(); };
    window.toggleVault = () => alert("User Data Vault (Last 7): \n" + vault.traits.join("\n"));
</script>
</body>
</html>
