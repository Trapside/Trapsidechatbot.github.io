<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Trapside Â· Code Intelligence</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --glass: rgba(255,255,255,.05);
  --glass-border: rgba(255,255,255,.15);
  --accent: #00b4ff;
  --liquid-bg: linear-gradient(135deg,#02010a,#0d1127 50%,#1a0b2e);
  --code-bg: #0b0e14;
  --code-border: #2a2f3a;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  font-family:'Inter',sans-serif;
  background:var(--liquid-bg) fixed;
  color:#fff;height:100vh;overflow:hidden
}
.container{height:100vh;display:flex;flex-direction:column}
.header{
  padding:24px;display:flex;justify-content:center;align-items:center;
  position:fixed;top:0;left:0;right:0;z-index:10
}
.brand{
  font-weight:900;font-size:28px;letter-spacing:2px;color:#fff;text-transform:uppercase;
  filter:drop-shadow(0 0 10px rgba(0,180,255,.3));position:relative
}
.brand:after{
  content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
  width:60px;height:3px;background:var(--accent);border-radius:3px
}
.view{
  flex:1;display:flex;flex-direction:column;overflow-y:auto;
  padding:100px 20px 120px;gap:20px
}
#chat-box{display:flex;flex-direction:column;gap:16px}
.message-row{display:flex;width:100%;align-items:flex-end;gap:12px}
.user-row{flex-direction:row-reverse}
.message{
  max-width:80%;padding:16px 22px 42px;border-radius:24px;font-size:15px;
  backdrop-filter:blur(15px);border:1px solid var(--glass-border);background:var(--glass);
  box-shadow:0 8px 32px rgba(0,0,0,.2);position:relative;line-height:1.6
}
.user-message{background:rgba(0,180,255,.1);border-color:rgba(0,180,255,.3);border-bottom-right-radius:4px}
.ai-message{border-bottom-left-radius:4px}
.thinking{font-weight:bold;color:var(--accent);animation:pulse 1.5s infinite}
@keyframes pulse{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}

.speak-btn{
  position:absolute;bottom:10px;right:10px;width:34px;height:34px;border-radius:50%;
  border:1px solid var(--glass-border);background:rgba(255,255,255,.08);color:#fff;
  display:flex;justify-content:center;align-items:center;cursor:pointer;transition:.3s;
  box-shadow:0 0 10px rgba(0,180,255,.2);z-index:5
}
.speak-btn:hover{background:rgba(255,255,255,.12);transform:scale(1.05)}
.speak-btn.active{background:var(--accent);box-shadow:0 0 15px var(--accent);border-color:var(--accent)}

.code-block-container{
  background:var(--code-bg);border:1px solid var(--code-border);padding:16px;border-radius:16px;
  font-family:'JetBrains Mono',monospace;font-size:14px;line-height:1.5;color:#e3e6eb;
  box-shadow:0 6px 20px rgba(0,0,0,.6);cursor:pointer;transition:.2s;white-space:pre-wrap
}
.code-block-container:hover{
  border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,180,255,.2)
}
.copy-btn{
  position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:8px;
  backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.1);color:#fff;cursor:pointer;display:flex;
  justify-content:center;align-items:center;transition:.2s;z-index:6
}
.copy-btn:hover{background:var(--accent);border-color:var(--accent)}
.copy-btn.copied{background:#00cc88;border-color:#00cc88}

.code-modal{
  display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;
  background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:10000;
  justify-content:center;align-items:center;padding:20px
}
.code-modal.active{display:flex}
.modal-content{
  background:#0a0c12;border:1px solid var(--accent);border-radius:24px;
  width:900px;max-width:90%;max-height:90%;display:flex;flex-direction:column;
  box-shadow:0 20px 60px rgba(0,180,255,.3)
}
.modal-header{
  padding:18px 24px;border-bottom:1px solid #2a2f3a;
  display:flex;justify-content:space-between;align-items:center
}
.close-modal{
  background:none;border:none;font-size:24px;color:rgba(255,255,255,.6);
  cursor:pointer;transition:.2s
}
.close-modal:hover{color:#fff}
.modal-body{
  padding:24px;overflow-y:auto;background:#0e1117;border-radius:0 0 24px 24px
}

.input-area{
  position:absolute;bottom:30px;left:0;right:0;display:flex;justify-content:center;
  pointer-events:none;padding:0 20px
}
.input-container{
  max-width:800px;width:100%;display:flex;gap:12px;padding:10px 14px;
  background:var(--glass);border:1px solid var(--glass-border);
  border-radius:40px;backdrop-filter:blur(30px);pointer-events:auto;
  transition:.3s;box-shadow:0 10px 40px rgba(0,0,0,.4)
}
.input-container:focus-within{
  box-shadow:0 10px 50px rgba(0,180,255,.3);
  border-color:rgba(0,180,255,.4)
}
.input-field{
  flex:1;background:0;border:0;outline:0;resize:none;color:#fff;
  font-size:16px;padding:10px 15px;line-height:1.5;max-height:120px
}
.input-field::placeholder{color:rgba(255,255,255,.4)}
.send-btn,.stop-btn{
  width:44px;height:44px;border-radius:50%;border:0;cursor:pointer;
  display:flex;justify-content:center;align-items:center;color:#fff;
  transition:.3s;flex-shrink:0
}
.send-btn{background:var(--accent)}
.stop-btn{background:#ff4d4d}
.send-btn:hover,.stop-btn:hover{transform:scale(1.05)}
.stop-btn:hover{background:#ff3333}

.view::-webkit-scrollbar{width:6px}
.view::-webkit-scrollbar-thumb{background:var(--accent);border-radius:6px}

@media(max-width:768px){
  .brand{font-size:24px}
  .message{max-width:90%;font-size:14px;padding:14px 18px 38px}
}
</style>
</head>

<body>
<div class="container">
  <div class="header"><span class="brand">Trapside</span></div>
  <div class="view" id="scroll-area"><div id="chat-box"></div></div>

  <div class="input-area">
    <div class="input-container">
      <textarea id="user-input" class="input-field" placeholder="Ask for code, algorithms, or system design..." rows="1"></textarea>
      <button id="send-btn" class="send-btn"><i class="fas fa-arrow-up"></i></button>
    </div>
  </div>
</div>

<div id="code-modal" class="code-modal">
  <div class="modal-content">
    <div class="modal-header">
      <span><i class="fas fa-code"></i> Full code</span>
      <button id="close-modal-btn" class="close-modal"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body"><pre id="modal-code-content"></pre></div>
  </div>
</div>

<script type="module">
import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

const CODING_EXPERTISE = `
You are Trapside, an elite software architect.
Rules:
1. Provide full runnable code.
2. Explain non-trivial logic.
3. Include edge cases & best practices.
4. Format with proper code fences.
5. Give test cases or usage examples.
6. Produce clean, modern, secure code.
7. Prefer simplicity + clarity.`.trim();

const synth=window.speechSynthesis;
let activeBtn=null,abortController=null;

function speak(text,btn){
  if(synth.speaking && activeBtn===btn){synth.cancel();btn.classList.remove("active");activeBtn=null;return}
  if(synth.speaking){synth.cancel();if(activeBtn)activeBtn.classList.remove("active")}
  const u=new SpeechSynthesisUtterance(text);
  const v=synth.getVoices();
  u.voice=v.find(x=>x.name.includes("Daniel"))||v.find(x=>x.lang.includes("en-GB"))||v[0];
  u.pitch=1.3;u.rate=1.0;
  u.onstart=()=>{btn.classList.add("active");activeBtn=btn}
  u.onend=()=>{if(activeBtn===btn){btn.classList.remove("active");activeBtn=null}}
  synth.speak(u);
}

function createCodeBlock(code,lang=""){
  const c=document.createElement("div");
  c.className="code-block-container";

  const pre=document.createElement("pre");
  const ce=document.createElement("code");
  ce.textContent=code;
  pre.appendChild(ce);
  c.appendChild(pre);

  const copy=document.createElement("button");
  copy.className="copy-btn";
  copy.innerHTML='<i class="fas fa-copy"></i>';

  copy.onclick=async e=>{
    e.stopPropagation();
    try{
      await navigator.clipboard.writeText(code);
      copySuccess(copy);
    }catch{
      const t=document.createElement("textarea");
      t.value=code;t.style.position="fixed";t.style.opacity="0";
      document.body.appendChild(t);t.select();
      try{document.execCommand("copy");copySuccess(copy)}catch{alert("Copy failed")}
      document.body.removeChild(t);
    }
  };

  function copySuccess(btn){
    btn.classList.add("copied");
    btn.innerHTML='<i class="fas fa-check"></i>';
    setTimeout(()=>{btn.classList.remove("copied");btn.innerHTML='<i class="fas fa-copy"></i>'},2000);
  }

  c.appendChild(copy);

  c.onclick=e=>{
    if(e.target.closest(".copy-btn"))return;
    const m=document.getElementById("code-modal");
    document.getElementById("modal-code-content").textContent=code;
    m.classList.add("active");
  };

  return c;
}

function formatMessage(txt){
  if(!txt)return txt;
  const re=/```(\w*)\n([\s\S]*?)```/g;
  let last=0,out=[],m;
  while((m=re.exec(txt))){
    if(m.index>last)out.push(document.createTextNode(txt.slice(last,m.index)));
    out.push(createCodeBlock(m[2],m[1]));
    last=m.index+m[0].length;
  }
  if(last<txt.length)out.push(document.createTextNode(txt.slice(last)));
  if(!out.length)return txt;

  const div=document.createElement("div");
  out.forEach(n=>div.appendChild(n));
  return div.innerHTML;
}

function addMessage(text,role,think=false){
  const row=document.createElement("div");
  row.className=`message-row ${role}-row`;

  const msg=document.createElement("div");
  msg.className=`message ${role}-message${think?" thinking":""}`;

  if(role==="ai"&&!think){
    const f=formatMessage(text);
    if(typeof f==="string")msg.innerHTML=f;else msg.innerText=text;

    const b=document.createElement("button");
    b.className="speak-btn";
    b.innerHTML='<i class="fas fa-volume-up"></i>';
    b.onclick=e=>{e.stopPropagation();speak(text,b)};
    msg.appendChild(b);
  } else msg.innerText=text;

  row.appendChild(msg);
  document.getElementById("chat-box").appendChild(row);
  const v=document.getElementById("scroll-area");
  v.scrollTop=v.scrollHeight;
  return msg;
}

function resetBtn(){
  const s=document.getElementById("send-btn");
  s.className="send-btn";s.innerHTML='<i class="fas fa-arrow-up"></i>';
  s.onclick=handleChat;
  abortController=null;
  document.getElementById("user-input").disabled=false;
}

function stopBtn(){
  const s=document.getElementById("send-btn");
  s.className="stop-btn";s.innerHTML='<i class="fas fa-stop"></i>';
  s.onclick=()=>abortController?.abort();
}

const wllama=new Wllama({
  'single-thread/wllama.wasm':'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
  'multi-thread/wllama.wasm':'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm'
});

async function init(){
  try{
    await wllama.loadModelFromHF('bartowski/SmolLM2-360M-Instruct-GGUF','SmolLM2-360M-Instruct-Q4_K_M.gguf');
    addMessage("Trapside is online. Ask me anything about programming.","ai");
  }catch{
    addMessage("System Offline.","ai");
  }
}

async function handleChat(){
  const input=document.getElementById("user-input");
  const text=input.value.trim();
  if(!text)return;
  addMessage(text,"user");
  input.value="";input.style.height="auto";input.disabled=true;

  const loader=addMessage("Thinking...","ai",true);
  stopBtn();

  abortController=new AbortController();

  try{
    const prompt=`<think>system\n${CODING_EXPERTISE}\n</think>user\n${text}\n<think>\n<think>assistant\n`;

    const r=await wllama.createCompletion(prompt,{
      nPredict:600,stop:["<think>"],sampling:{temp:.5},signal:abortController.signal
    });

    loader.classList.remove("thinking");
    const clean=r.trim();
    const f=formatMessage(clean);
    loader.innerHTML=typeof f==="string"?f:clean;

    const b=document.createElement("button");
    b.className="speak-btn";b.innerHTML='<i class="fas fa-volume-up"></i>';
    b.onclick=e=>{e.stopPropagation();speak(clean,b)};
    loader.appendChild(b);

  }catch(e){
    loader.classList.remove("thinking");
    loader.innerText=abortController.signal.aborted?"[Stopped]":"Error generating response.";
  }
  resetBtn();
}

document.getElementById("user-input").addEventListener("input",function(){
  this.style.height="auto";
  this.style.height=this.scrollHeight+"px";
});
document.getElementById("send-btn").onclick=handleChat;
document.getElementById("user-input").onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();handleChat()}};

document.getElementById("close-modal-btn").onclick=()=>document.getElementById("code-modal").classList.remove("active");
window.onclick=e=>{if(e.target===document.getElementById("code-modal"))document.getElementById("code-modal").classList.remove("active")};

init();
</script>
</body>
</html>
