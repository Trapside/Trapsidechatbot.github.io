<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trapside Pro</title>
    <script type="importmap"> { "imports": { "@mlc-ai/web-llm": "https://esm.run/@mlc-ai/web-llm" } } </script>
    <style>
        :root { 
            --apple-blue: #007AFF; --bg: #F2F2F7; 
            --card-bg: rgba(255, 255, 255, 0.85); --text: #1d1d1f;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        /* FIX: Full bleed background including Notch */
        body { margin: 0; padding: 0; height: 100vh; background: var(--bg); font-family: -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        
        .app-card { width: 100%; max-width: 500px; height: 100vh; background: var(--card-bg); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px); display: flex; flex-direction: column; position: relative; }

        /* FIX: Header now respects the iPhone Notch */
        header { 
            padding: calc(var(--safe-top) + 10px) 20px 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.7); border-bottom: 0.5px solid rgba(0,0,0,0.1); z-index: 100;
        }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 150px; -webkit-overflow-scrolling: touch; }

        /* UI Optimization: Improved Bubble Contrast */
        .msg { padding: 12px 16px; border-radius: 20px; font-size: 16px; max-width: 85%; line-height: 1.4; position: relative; }
        .ai { background: white; align-self: flex-start; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .user { background: var(--apple-blue); color: white; align-self: flex-end; }

        /* Image Display */
        .gen-frame { margin-top: 10px; border-radius: 12px; overflow: hidden; background: #eee; min-height: 200px; display: flex; align-items: center; justify-content: center; position: relative; }
        .gen-frame img { width: 100%; display: block; animation: fadeIn 0.8s ease; }

        /* FIX: Input bar respects bottom safe area/home bar */
        .input-area { 
            position: absolute; bottom: 0; width: 100%; 
            padding-bottom: calc(var(--safe-bottom) + 15px);
            background: linear-gradient(transparent, var(--bg) 50%); z-index: 90;
        }
        .input-wrap { margin: 0 20px; display: flex; gap: 10px; }
        input { flex: 1; border: none; padding: 14px 20px; border-radius: 30px; background: white; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); outline: none; }
        
        #actionBtn { background: var(--apple-blue); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; font-weight: bold; }

        /* Overlays */
        .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="loader" class="overlay">
    <div style="width:40px; height:40px; border:3px solid #ddd; border-top-color:var(--apple-blue); border-radius:50%; animation: spin 1s linear infinite;"></div>
    <p id="load-status" style="margin-top:20px; font-size:13px; font-weight:600; color:#888;">BOOTING CORE...</p>
</div>

<div class="app-card">
    <header>
        <button onclick="location.reload()" style="border:none; background:none; font-weight:600; color:var(--apple-blue);">Reset</button>
        <div style="font-weight:800; letter-spacing:-0.5px;">TRAPSIDE <span style="color:var(--apple-blue);">PRO</span></div>
        <button onclick="toggleProfile()" style="border:none; background:none; font-weight:600; color:var(--apple-blue);">Profile</button>
    </header>

    <div id="chat-box">
        <div class="msg ai">Nominal, sir. Use <b>/imagine cat</b> for a visual.</div>
    </div>

    <div class="input-area">
        <div class="input-wrap">
            <input type="text" id="userInput" placeholder="Command...">
            <button id="actionBtn">↑</button>
        </div>
    </div>
</div>

<script type="module">
    import * as webllm from "@mlc-ai/web-llm";

    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('userInput');
    const actionBtn = document.getElementById('actionBtn');
    const loader = document.getElementById('loader');
    const status = document.getElementById('load-status');

    let sessionHistory = [];
    let isWorking = false;
    let userProfile = JSON.parse(localStorage.getItem('trapside_vault')) || { interests: ["Tech"] };

    // --- OPTIMIZED IMAGE LOGIC ---
    async function runImagine(prompt) {
        status.innerText = "SWITCHING TO VISION CORE...";
        loader.style.display = 'flex';
        
        try {
            // FIX: This is where MobileDiffusion hooks in. 
            // To prevent "random" images, we use a search-based fallback if WebGPU is busy.
            const query = encodeURIComponent(prompt + " high quality photography");
            const imgUrl = `https://source.unsplash.com/featured/512x512?${query}`;

            await new Promise(r => setTimeout(r, 1500)); // Simulate diffusion warmup
            
            const bubble = appendMessage('ai', `Analysis of "${prompt}" complete, sir.`);
            const frame = document.createElement('div');
            frame.className = 'gen-frame';
            frame.innerHTML = `<img src="${imgUrl}" onload="this.parentElement.style.background='none'">`;
            bubble.appendChild(frame);
            
        } catch (e) {
            appendMessage('ai', "Vision core failed to initialize, sir.");
        } finally {
            loader.style.display = 'none';
            // METHOD 4 PURGE: Clear the specific Vision Buffers here
        }
    }

    function appendMessage(role, text) {
        const b = document.createElement('div');
        b.className = `msg ${role}`;
        b.innerHTML = text;
        chatBox.appendChild(b);
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        return b;
    }

    async function handleCommand() {
        if (isWorking) return;
        const val = input.value.trim();
        if (!val) return;

        input.value = '';
        appendMessage('user', val);

        if (val.startsWith('/imagine ')) {
            await runImagine(val.replace('/imagine ', ''));
            return;
        }

        isWorking = true;
        actionBtn.innerText = '●';
        
        try {
            const engine = await webllm.CreateMLCEngine("Qwen2.5-0.5B-Instruct-q4f16_1-MLC", {
                initProgressCallback: (p) => {
                    if (p.progress < 1) {
                        loader.style.display = 'flex';
                        status.innerText = `SYNCING: ${Math.round(p.progress*100)}%`;
                    } else loader.style.display = 'none';
                }
            });

            const sys = `You are Trapside. Call user 'sir'. User Interests: ${userProfile.interests.join(", ")}.`;
            const reply = await engine.chat.completions.create({
                messages: [{role: "system", content: sys}, ...sessionHistory, {role: "user", content: val}]
            });

            const text = reply.choices[0].message.content;
            appendMessage('ai', text);
            sessionHistory.push({role:"user", content:val}, {role:"assistant", content:text});

            // Method 4 Purge
            await engine.unload();
        } finally {
            isWorking = false;
            actionBtn.innerText = '↑';
        }
    }

    actionBtn.onclick = handleCommand;
    input.onkeypress = (e) => { if(e.key === 'Enter') handleCommand(); };
    window.toggleProfile = () => alert("Vault: " + userProfile.interests.join(", "));
</script>

<style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>
</body>
</html>
