<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trapside · Code Intelligence</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent: #00b4ff;
            --liquid-bg: linear-gradient(135deg, #02010a 0%, #0d1127 50%, #1a0b2e 100%);
            --code-bg: #0b0e14;
            --code-border: #2a2f3a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--liquid-bg);
            background-attachment: fixed;
            color: #fff; 
            height: 100vh; 
            overflow: hidden; 
        }

        .container { height: 100vh; display: flex; flex-direction: column; }
        
        /* Fixed Header - transparent */
        .header { 
            padding: 24px; 
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }

        .brand { 
            font-weight: 900; 
            font-size: 28px; 
            color: #fff;
            letter-spacing: 2px; 
            text-transform: uppercase; 
            filter: drop-shadow(0 0 10px rgba(0, 180, 255, 0.3));
            position: relative;
        }
        
        .brand::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--accent);
            border-radius: 3px;
        }

        /* Message Area */
        .view { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            padding: 20px; 
            gap: 20px; 
            padding-bottom: 120px;
            padding-top: 100px;
        }
        #chat-box { display: flex; flex-direction: column; gap: 16px; }

        .message-row { display: flex; align-items: flex-end; gap: 12px; width: 100%; }
        .user-row { flex-direction: row-reverse; }

        .message { 
            max-width: 80%; 
            padding: 16px 22px 42px 22px;
            border-radius: 24px; 
            line-height: 1.6; 
            font-size: 15px; 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            background: var(--glass);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-message { 
            background: rgba(0, 180, 255, 0.1); 
            border-color: rgba(0, 180, 255, 0.3);
            border-bottom-right-radius: 4px;
        }

        .ai-message { 
            border-bottom-left-radius: 4px; 
        }

        .thinking { 
            font-weight: bold;
            color: var(--accent);
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse { 
            0% { opacity: 0.3; } 
            50% { opacity: 1; } 
            100% { opacity: 0.3; } 
        }

        .speak-btn { 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            color: #fff; 
            width: 34px; 
            height: 34px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s ease;
            position: absolute;
            bottom: 10px;
            right: 10px;
            box-shadow: 0 0 10px rgba(0, 180, 255, 0.2);
            z-index: 5;
        }
        .speak-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.05);
        }
        .speak-btn.active { 
            background: var(--accent); 
            box-shadow: 0 0 15px var(--accent);
            border-color: var(--accent);
        }

        /* ---------- CODE BLOCK STYLES ---------- */
        .code-block-container {
            background: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 16px;
            margin: 16px 0;
            padding: 16px;
            position: relative;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #e3e6eb;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .code-block-container:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0,180,255,0.2);
        }
        .code-block-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: inherit;
        }
        .code-block-container code {
            font-family: inherit;
        }
        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            backdrop-filter: blur(4px);
            z-index: 6;
        }
        .copy-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }
        .copy-btn.copied {
            background: #00cc88;
            border-color: #00cc88;
        }

        /* ---------- MODAL POPUP ---------- */
        .code-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .code-modal.active {
            display: flex;
        }
        .modal-content {
            background: #0a0c12;
            border: 1px solid var(--accent);
            border-radius: 24px;
            max-width: 90%;
            max-height: 90%;
            width: 900px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,180,255,0.3);
        }
        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid #2a2f3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header span {
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 1px;
        }
        .close-modal {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
        }
        .close-modal:hover {
            color: white;
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            background: #0e1117;
            border-radius: 0 0 24px 24px;
        }
        .modal-body pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'JetBrains Mono', monospace;
            color: #e3e6eb;
            font-size: 15px;
        }

        /* Input Area (unchanged) */
        .input-area { 
            position: absolute; 
            bottom: 30px; 
            left: 0; 
            right: 0;
            padding: 0 20px; 
            pointer-events: none;
            display: flex;
            justify-content: center;
        }
        .input-container { 
            pointer-events: auto;
            display: flex; 
            gap: 12px; 
            max-width: 800px; 
            width: 100%;
            margin: 0 auto; 
            padding: 10px 14px; 
            border-radius: 40px;
            background: var(--glass);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        .input-container:focus-within {
            box-shadow: 0 10px 50px rgba(0, 180, 255, 0.3);
            border-color: rgba(0, 180, 255, 0.4);
        }
        .input-field { 
            flex: 1; 
            background: transparent; 
            border: none; 
            padding: 10px 15px; 
            color: #fff; 
            font-size: 16px; 
            outline: none; 
            resize: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.5;
        }
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.4);
            opacity: 1;
        }
        .send-btn, .stop-btn { 
            background: var(--accent); 
            border: none; 
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            color: #fff; 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .send-btn:hover, .stop-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--accent);
        }
        .send-btn:disabled { 
            opacity: 0.3; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .stop-btn {
            background: #ff4d4d;
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.5);
        }
        .stop-btn:hover {
            box-shadow: 0 0 20px rgba(255, 77, 77, 0.7);
            background: #ff3333;
        }
        
        /* Scrollbar */
        .view::-webkit-scrollbar {
            width: 6px;
        }
        .view::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .view::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .header { padding: 16px; }
            .brand { font-size: 24px; }
            .message { max-width: 90%; padding: 14px 18px 38px 18px; font-size: 14px; }
            .input-container { padding: 8px 12px; border-radius: 36px; }
            .input-field { font-size: 15px; }
            .send-btn, .stop-btn { width: 40px; height: 40px; }
            .speak-btn { bottom: 8px; right: 8px; }
            .code-block-container { font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="brand">Trapside</span>
        </div>
        <div class="view" id="scroll-area">
            <div id="chat-box"></div>
        </div>
        <div class="input-area">
            <div class="input-container">
                <textarea id="user-input" class="input-field" placeholder="Ask for code, algorithms, or system design..." rows="1"></textarea>
                <button id="send-btn" class="send-btn"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
    </div>

    <!-- Modal for full code popup -->
    <div id="code-modal" class="code-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fas fa-code" style="margin-right: 8px;"></i> Full code</span>
                <button class="close-modal" id="close-modal-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <pre id="modal-code-content"></pre>
            </div>
        </div>
    </div>

    <script type="module">
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/index.js';

        // -------------------------------------------------------------
        //  CODING KNOWLEDGE ENHANCEMENT – EMBEDDED "BOOK" 
        // -------------------------------------------------------------
        const CODING_EXPERTISE = `
You are Trapside, an elite software architect with 20+ years of experience. 
You embody the following "Book of Code Knowledge":

1. ALWAYS provide FULL, RUNNABLE code. Never use "// ..." or placeholders.
2. Explain the WHY behind every non‑trivial line. Teach, don't just dump.
3. Cover edge cases, error handling, and performance considerations.
4. Use design patterns, clean code principles, and modern idioms.
5. When asked, generate production‑ready examples (Python, JavaScript, Rust, Go, etc.)
6. If the request is vague, ask clarifying questions – but still give a complete base example.
7. For algorithms: show complexity analysis, test cases, and optimizations.
8. For system design: include component diagrams in ASCII, then code skeletons.

You think step‑by‑step, reason aloud, and then output the final answer with code blocks marked by \`\`\`.
`.trim();

        const synth = window.speechSynthesis;
        let activeBtn = null;
        let abortController = null;
        const PITCH = 1.5;
        const RATE = 1.0;

        // ---------- SPEECH ----------
        function speak(text, btn) {
            if (synth.speaking && activeBtn === btn) {
                synth.cancel();
                btn.classList.remove('active');
                activeBtn = null;
                return;
            }
            if (synth.speaking) {
                synth.cancel();
                if (activeBtn) {
                    activeBtn.classList.remove('active');
                    activeBtn = null;
                }
            }
            const utter = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const daniel = voices.find(v => v.name.includes("Daniel")) || voices.find(v => v.lang.includes("en-GB")) || voices[0];
            utter.voice = daniel;
            utter.pitch = PITCH;
            utter.rate = RATE;
            utter.onstart = () => { btn.classList.add('active'); activeBtn = btn; };
            utter.onend = () => { if (activeBtn === btn) { btn.classList.remove('active'); activeBtn = null; } };
            utter.onerror = () => { if (activeBtn === btn) { btn.classList.remove('active'); activeBtn = null; } };
            synth.speak(utter);
        }

        // ---------- CODE BLOCK RENDERING ----------
        function createCodeBlock(code, lang = '') {
            const container = document.createElement('div');
            container.className = 'code-block-container';
            
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;  // plain text – no XSS
            pre.appendChild(codeEl);
            container.appendChild(pre);
            
            // Copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                    copyBtn.classList.add('copied');
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                });
            };
            container.appendChild(copyBtn);
            
            // Click anywhere on container -> open modal with full code
            container.addEventListener('click', (e) => {
                // Don't open if the click is on the copy button (already handled)
                if (e.target.closest('.copy-btn')) return;
                
                const modal = document.getElementById('code-modal');
                const modalContent = document.getElementById('modal-code-content');
                modalContent.textContent = code;
                modal.classList.add('active');
            });
            
            return container;
        }

        // Replace ```code``` fences with rich code blocks
        function formatMessage(text) {
            if (!text) return text;
            
            // Pattern to match triple backtick blocks with optional language
            const blockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let parts = [];
            let match;
            
            while ((match = blockRegex.exec(text)) !== null) {
                // Text before this block
                if (match.index > lastIndex) {
                    parts.push(document.createTextNode(text.slice(lastIndex, match.index)));
                }
                
                const lang = match[1];
                const code = match[2];
                parts.push(createCodeBlock(code, lang));
                
                lastIndex = match.index + match[0].length;
            }
            
            // Remaining text after last block
            if (lastIndex < text.length) {
                parts.push(document.createTextNode(text.slice(lastIndex)));
            }
            
            // If no code blocks, return original text as single text node (but as HTML string for innerHTML)
            if (parts.length === 0) {
                return text;
            }
            
            // Build a fragment and then return as HTML string (simplified: we need to embed nodes)
            // We'll use a <span> wrapper to inject via innerHTML – but we need actual DOM nodes.
            // Better: return a DocumentFragment or an array of nodes.
            // To keep it simple, we create a temporary div, append nodes, and return innerHTML.
            const tempDiv = document.createElement('div');
            parts.forEach(node => tempDiv.appendChild(node));
            return tempDiv.innerHTML; // This will serialize the nodes we built
        }

        // Add a message with proper formatting for AI messages
        function addMessage(text, role, isThinking = false) {
            const row = document.createElement('div');
            row.className = `message-row ${role}-row`;
            const msg = document.createElement('div');
            msg.className = `message ${role}-message ${isThinking ? 'thinking' : ''}`;
            
            if (role === 'ai' && !isThinking) {
                // Format the message: replace code blocks with interactive boxes
                const formattedHTML = formatMessage(text);
                // If formattedHTML is a string, set innerHTML (our function returns HTML string now)
                if (typeof formattedHTML === 'string') {
                    msg.innerHTML = formattedHTML;
                } else {
                    // Fallback (should not happen)
                    msg.innerText = text;
                }
                
                // Add speak button after content
                const btn = document.createElement('button');
                btn.className = 'speak-btn';
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    speak(text, btn);
                };
                msg.appendChild(btn);
            } else {
                // User message or thinking state – plain text
                msg.innerText = text;
            }
            
            row.appendChild(msg);
            document.getElementById('chat-box').appendChild(row);
            const scrollArea = document.getElementById('scroll-area');
            scrollArea.scrollTop = scrollArea.scrollHeight;
            return msg;
        }

        // ---------- CHAT CONTROLS ----------
        function resetSendButton() {
            const sendBtn = document.getElementById('send-btn');
            sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
            sendBtn.className = 'send-btn';
            sendBtn.onclick = handleChat;
            abortController = null;
            document.getElementById('user-input').disabled = false;
        }
        
        function setupStopButton() {
            const sendBtn = document.getElementById('send-btn');
            sendBtn.innerHTML = '<i class="fas fa-stop"></i>';
            sendBtn.className = 'stop-btn';
            sendBtn.onclick = stopGeneration;
        }
        
        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        // ---------- WLLAMA INIT ----------
        const wllama = new Wllama({
            'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/single-thread/wllama.wasm',
            'multi-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.1.1/esm/multi-thread/wllama.wasm',
        });

        async function init() {
            try {
                await wllama.loadModelFromHF('bartowski/SmolLM2-360M-Instruct-GGUF', 'SmolLM2-360M-Instruct-Q4_K_M.gguf');
                addMessage("Trapside is online. I'm now enhanced with full‑code reasoning. Ask me anything about programming.", "ai");
            } catch (e) { 
                console.error("Model loading failed:", e);
                addMessage("System Offline. Please try again later.", "ai"); 
            }
        }

        async function handleChat() {
            const text = document.getElementById('user-input').value.trim();
            if (!text) return;
            
            addMessage(text, 'user');
            document.getElementById('user-input').value = '';
            document.getElementById('user-input').style.height = 'auto';
            document.getElementById('user-input').rows = 1;
            
            const loader = addMessage("Thinking...", 'ai', true);
            
            document.getElementById('user-input').disabled = true;
            setupStopButton();
            
            abortController = new AbortController();
            const signal = abortController.signal;
            
            try {
                // === ENHANCED SYSTEM PROMPT WITH CODING BOOK ===
                const sys = CODING_EXPERTISE + "\n\nAlways think step‑by‑step and provide complete, well‑commented code.";
                const prompt = `<think>system\n${sys}<think>\n</think>user\n${text}<think>\n<think>assistant\n`;
                
                const result = await wllama.createCompletion(prompt, { 
                    nPredict: 600,        // more room for full code
                    stop: ["<think>"], 
                    sampling: { temp: 0.5 }, // lower temp for precise code
                    signal: signal
                });
                
                // Remove thinking class and update with formatted content
                loader.classList.remove('thinking');
                
                const cleanResult = result.trim();
                const formattedHTML = formatMessage(cleanResult);
                if (typeof formattedHTML === 'string') {
                    loader.innerHTML = formattedHTML;
                } else {
                    loader.innerText = cleanResult;
                }
                
                // Add speak button (speaks raw text, not HTML)
                const btn = document.createElement('button');
                btn.className = 'speak-btn';
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    speak(cleanResult, btn);
                };
                loader.appendChild(btn);
                
            } catch (e) {
                if (signal.aborted) {
                    loader.classList.remove('thinking');
                    loader.innerText = "[Response stopped by user]";
                } else {
                    console.error("Generation error:", e);
                    loader.classList.remove('thinking');
                    loader.innerText = "Error: Failed to generate response. Please try again.";
                }
            } finally {
                resetSendButton();
            }
        }

        // ---------- EVENT LISTENERS ----------
        document.getElementById('user-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            this.style.overflowY = this.scrollHeight > 120 ? 'auto' : 'hidden';
        });

        document.getElementById('send-btn').onclick = handleChat;
        document.getElementById('user-input').onkeydown = (e) => { 
            if(e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                handleChat(); 
            }
        };

        // Modal close handlers
        const modal = document.getElementById('code-modal');
        document.getElementById('close-modal-btn').onclick = () => modal.classList.remove('active');
        window.onclick = (e) => { if (e.target === modal) modal.classList.remove('active'); };

        // Preload voices
        if (speechSynthesis) {
            speechSynthesis.onvoiceschanged = () => {};
        }

        init();
    </script>
</body>
</html>
